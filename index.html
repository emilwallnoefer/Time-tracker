<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hour Logger</title>

  <!-- PWA essentials -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root { --pad: 16px; --radius: 16px; --bg: #fafafa; --card: #ffffff; --muted: #6b7280; --text: #111827; }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: -apple-system, system-ui, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); }

    /* Top bar */
    .topbar { position: sticky; top: 0; display: flex; align-items: center; gap: 8px; padding: 12px var(--pad); background: #fff; border-bottom: 1px solid #eee; z-index: 10; }
    .back { border: 1px solid #e5e7eb; background: #fff; border-radius: 12px; padding: 8px 12px; font-size: 14px; }
    .title { font-weight: 700; font-size: 18px; margin-left: 4px; }
    .spacer { flex: 1; }
    .pill { display: inline-block; padding: 4px 10px; border: 1px solid #e5e7eb; border-radius: 999px; font-size: 12px; color: #374151; background: #fff; }

    /* Views */
    .view { display: none; padding: var(--pad); }
    .view.active { display: block; }

    /* Hero */
    .hero { position: relative; min-height: 140px; border-radius: 24px; overflow: hidden; background: radial-gradient(80% 80% at 50% 30%, #eef6ff, #fff); border: 1px solid #eef2f7; box-shadow: 0 1px 4px rgba(0,0,0,.06); display: flex; align-items: center; justify-content: center; }
    .hero::after { content: ""; position: absolute; inset: 0; background-image: url('icon-512.png'); background-size: 50%; background-position: center; background-repeat: no-repeat; opacity: .06; }
    .hero h1 { position: relative; z-index: 1; font-size: 24px; margin: 0; }

    .cards { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 14px; }
    .card { background: var(--card); border: 1px solid #eee; border-radius: 18px; padding: 16px; display: flex; align-items: center; gap: 12px; box-shadow: 0 1px 3px rgba(0,0,0,.05); }
    .card h3 { margin: 0; font-size: 18px; }
    .card p { margin: 4px 0 0; color: var(--muted); font-size: 14px; }
    .card button { margin-left: auto; border: 1px solid #111; background: #111; color: #fff; border-radius: 12px; padding: 10px 14px; }

    /* Groups, inputs, buttons */
    .group { background: var(--card); border: 1px solid #eee; border-radius: 16px; padding: 14px; margin-bottom: 12px; }
    label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    input[type="time"], input[type="date"], input[type="text"], input[type="number"] { width: 100%; border: 1px solid #e5e7eb; border-radius: 12px; padding: 10px; font-size: 16px; }
    .btn { border: 1px solid #e5e7eb; background: #fff; border-radius: 12px; padding: 10px 14px; font-size: 15px; }
    .btn.primary { background: #111; border-color: #111; color: #fff; }
    .btn.danger { border-color: #ef4444; color: #ef4444; }

    /* Logger responsive layout */
    .logger-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
    .logger-grid > div { align-self: flex-start; }
    .center { text-align:center; }
    @media (min-width: 520px) { .logger-grid { grid-template-columns: 1fr auto 1fr; align-items: start; } }

    /* Calendar */
    .cal-wrap { background: var(--card); border: 1px solid #eee; border-radius: 16px; padding: 10px; }
    .cal-head { display: flex; align-items: center; gap: 8px; padding: 8px; flex-wrap: wrap; }
    .cal-title { font-weight: 700; }
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; padding: 8px; }
    .dow { text-align: center; font-size: 12px; color: var(--muted); }
    .day { border: 1px solid #eee; border-radius: 12px; padding: 8px; min-height: 90px; position: relative; background: #fff; overflow:hidden; }
    .day .n { position: absolute; top: 6px; left: 6px; font-size: 12px; color: #111; font-weight:700; z-index:2; }
    .day .h { position: absolute; bottom: 6px; right: 6px; font-weight: 700; font-size: 12px; color: #111; z-index:2; }
    .day .pct { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; color:#0f5132; opacity:.95; pointer-events:none; z-index:2; }
    .day.today { outline: 2px solid #111; }
    .cal-footer { display:flex; gap:8px; flex-wrap:wrap; padding: 10px; border-top:1px solid #eee; margin-top:8px; border-radius: 0 0 12px 12px; background:#fff; }

    /* Big background bars inside calendar day */
    .bg-bars { position:absolute; left:4px; right:4px; top:22px; height:58px; display:flex; gap:6px; z-index:1; }
    .bg-half { position:relative; flex:1; border-radius:10px; background:#f7f7f7; border:1px solid #e5e7eb; overflow:hidden; }
    .fill { position:absolute; top:0; left:0; height:100%; }
    .green { background:#a7f3d0; }
    .red { background:#fecaca; }
    .violet { background:#e9d5ff; }

    /* Breaks list (mobile tidy) */
    #breaksPane { max-height: 220px; overflow:auto; padding-right:4px; }
    .breaks.active { display:block; }
    .break-item { display:grid; grid-template-columns: 1.2fr 1fr 1fr auto; gap:6px; align-items:end; margin-bottom:6px; }
    .break-item small { color: var(--muted); display:block; margin-bottom:4px; }

    .muted { color: var(--muted); font-size: 13px; }
    .total { display:flex; justify-content:space-between; align-items:center; padding-top:6px; }
  </style>
</head>
<body>
  <div class="topbar">
    <button class="back" id="btnBack" style="visibility:hidden">◀︎ Back</button>
    <div class="title">Hour Logger</div>
    <div class="spacer"></div>
    <span class="pill" id="pillToday">—</span>
  </div>

  <!-- MENU VIEW -->
  <section id="view-menu" class="view active">
    <div class="hero"><h1>Track your day</h1></div>

    <div style="margin-top:12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <span class="pill" id="pillTodayHours">Today: 0h 00m</span>
      <span class="pill" id="pillBank">Overtime bank: 0h 00m</span>
    </div>

    <div class="cards">
      <div class="card">
        <div>
          <h3 id="todayCardTitle">Today’s logging</h3>
          <p>Working time (-breaks), start / stop, breaks, save.</p>
        </div>
        <button id="goLogger">Open</button>
      </div>

      <div class="card">
        <div>
          <h3>Calendar</h3>
          <p>See/edit any day’s details.</p>
        </div>
        <button id="goCalendar">Open</button>
      </div>

      <div class="card">
        <div>
          <h3>Compensate overtime</h3>
          <p>Reduce the bank by logging compensation.</p>
        </div>
        <button id="goComp">Add</button>
      </div>
    </div>
  </section>

  <!-- CALENDAR VIEW -->
  <section id="view-calendar" class="view">
    <div class="cal-wrap">
      <div class="cal-head">
        <button class="btn" id="calPrev">◀︎</button>
        <div class="cal-title" id="calTitle">Month YYYY</div>
        <button class="btn" id="calNext">▶︎</button>
        <div class="spacer"></div>
        <button class="btn" id="calToday">Today</button>
      </div>
      <div class="cal-grid" id="calDOW"></div>
      <div class="cal-grid" id="calGrid"></div>
      <div class="drawer" id="dayDrawer"></div>
      <div class="cal-footer" id="calFooter"></div>
    </div>
  </section>

  <!-- LOGGER VIEW -->
  <section id="view-logger" class="view">
    <div class="group">
      <label>Date</label>
      <input type="date" id="logDate" />
      <div style="margin-top:8px">
        <label style="display:flex; align-items:center; gap:8px;">
          <input type="checkbox" id="holidayFlag" />
          <span>Public holiday (full day)</span>
        </label>
      </div>
    </div>

    <div class="group">
      <div class="logger-grid">
        <div>
          <label><strong>Start</strong></label>
          <input type="time" id="startTime" />
          <button class="btn" id="btnStartNow" style="margin-top:8px; width:100%">Start now</button>
        </div>
        <div class="center">
          <button class="btn" id="btnAddBreak">+ Add break</button>
          <div class="breaks" id="breaksPane"></div>
        </div>
        <div>
          <label><strong>Stop</strong></label>
          <input type="time" id="stopTime" />
          <button class="btn" id="btnStopNow" style="margin-top:8px; width:100%">Stop now</button>
        </div>
      </div>
      <div class="total">
        <span class="muted">Working time (-breaks)</span>
        <strong id="computedTotal">0h 00m</strong>
      </div>
    </div>

    <div class="group">
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn primary" id="btnSave">Save day</button>
        <button class="btn danger" id="btnResetWork">Reset this day</button>
      </div>
    </div>
  </section>

  <!-- COMPENSATE OVERTIME VIEW -->
  <section id="view-comp" class="view">
    <div class="group">
      <label>Date for compensation</label>
      <input type="date" id="compDate" />
    </div>
    <div class="group">
      <div class="row" style="display:flex; gap:8px; flex-wrap:wrap;">
        <div style="flex:1; min-width:120px;">
          <label>Hours</label>
          <input type="number" id="compHours" min="0" value="0" />
        </div>
        <div style="flex:1; min-width:120px;">
          <label>Minutes</label>
          <input type="number" id="compMinutes" min="0" max="59" value="0" />
        </div>
        <div style="align-self:end;">
          <button class="btn" id="btnFullDay">Full day (8h24m)</button>
        </div>
      </div>
      <div class="row" style="margin-top:8px;">
        <div style="flex:1;">
          <label>Note (optional)</label>
          <input type="text" id="compNote" placeholder="Doctor, PTO, etc." />
        </div>
      </div>
      <div class="pill" id="compBalance">Overtime bank: 0h 00m</div>
    </div>
    <div class="group">
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn primary" id="btnSaveComp">Save compensation</button>
        <button class="btn danger" id="btnResetComp">Reset compensation for this day</button>
      </div>
    </div>
  </section>

  <script>
    // ---- Constants ----
    const TARGET = 504; // fixed daily target = 8h24m

    // ---- Persistence (schema v15) ----
    const KEY = 'hourlogger.v15';
    const state = JSON.parse(localStorage.getItem(KEY) || '{}');
    state.work ||= {};    // { 'YYYY-MM-DD': { start, stop, breaks[], netMins, holiday?:true } }
    state.comp ||= {};    // { 'YYYY-MM-DD': { mins, note? } }
    function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

    // ---- Date helpers ----
    const pad = n => String(n).padStart(2,'0');
    const toDateStr = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const fromDateStr = s => { const [y,m,da]=s.split('-').map(Number); return new Date(y, m-1, da); };
    const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    const dows = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    const fmtHM = mins => `${Math.floor(Math.abs(mins)/60)}h ${pad(Math.abs(mins)%60)}m`;
    const fmtSignedHM = mins => (mins<0?'-':'') + fmtHM(mins);

    // ---- Per-day helpers ----
    function workMins(ds){ return state.work[ds]?.netMins || 0; }
    function compMins(ds){ return state.comp[ds]?.mins || 0; }
    function isHoliday(ds){ return !!state.work[ds]?.holiday; }
    function hasWork(ds){ return !!state.work[ds] && (state.work[ds].start || state.work[ds].stop || (state.work[ds].breaks||[]).length || state.work[ds].netMins>0); }

    // Left bar percentage: (work+comp) capped at 100% purely for visualization;
    // Logic-wise the bank follows rules below.
    function completionPct(ds){
      const total = workMins(ds) + compMins(ds);
      return Math.max(0, Math.min(1, total / TARGET));
    }

    // Day impact rules (your spec):
    // - Holiday => 0
    // - No work & no comp => 0
    // - Work day => impact = work - TARGET  (comp on same day is ignored)
    // - Comp-only day => impact = -comp
    function dayBankDelta(ds){
      if (isHoliday(ds)) return 0;
      const w = workMins(ds);
      const c = compMins(ds);
      if (hasWork(ds)) return w - TARGET;
      if (!hasWork(ds) && c>0) return -c;
      return 0;
    }

    function overtimeBank(){
      const dates = new Set([...Object.keys(state.work), ...Object.keys(state.comp)]);
      let total = 0;
      dates.forEach(ds => { total += dayBankDelta(ds); });
      return total;
    }

    function monthWorkedMins(year, month){
      let total=0; for (let d=new Date(year,month,1); d<=new Date(year,month+1,0); d.setDate(d.getDate()+1)) total += workMins(toDateStr(d)); return total;
    }

    // ---- View management ----
    const views = { menu: document.getElementById('view-menu'), calendar: document.getElementById('view-calendar'), logger: document.getElementById('view-logger'), comp: document.getElementById('view-comp') };
    const btnBack = document.getElementById('btnBack');
    function show(name){ Object.values(views).forEach(v=>v.classList.remove('active')); views[name].classList.add('active'); btnBack.style.visibility = (name==='menu') ? 'hidden' : 'visible'; if (name==='menu') renderMenu(); if (name==='calendar') renderCalendar(); if (name==='logger') renderLogger(); if (name==='comp') renderComp(); }
    btnBack.addEventListener('click', ()=>show('menu'));

    // ---- Menu ----
    const pillToday = document.getElementById('pillToday'), pillTodayHours = document.getElementById('pillTodayHours'), pillBank = document.getElementById('pillBank');
    document.getElementById('goCalendar').addEventListener('click', ()=>show('calendar'));
    document.getElementById('goLogger').addEventListener('click', ()=>show('logger'));
    document.getElementById('goComp').addEventListener('click', ()=>show('comp'));

    function renderMenu(){
      const now = new Date(); const dStr = toDateStr(now);
      pillToday.textContent = dStr;
      pillTodayHours.textContent = "Today: " + fmtHM(workMins(dStr));
      pillBank.textContent = "Overtime bank: " + fmtSignedHM(overtimeBank());
    }

    // ---- Calendar ----
    const calTitle = document.getElementById('calTitle'), calDOW = document.getElementById('calDOW'), calGrid = document.getElementById('calGrid'), dayDrawer = document.getElementById('dayDrawer'), calFooter = document.getElementById('calFooter'); let monthOffset = 0;
    function startOfMonthWithMondayGrid(date){ const first = new Date(date.getFullYear(), date.getMonth(), 1); const day = (first.getDay() + 6) % 7; first.setDate(first.getDate() - day); first.setHours(0,0,0,0); return first; }
    function renderCalendar(){
      const base = new Date(); base.setMonth(base.getMonth()+monthOffset);
      calTitle.textContent = monthNames[base.getMonth()] + " " + base.getFullYear();
      calDOW.innerHTML=''; dows.forEach(d=>{ const el=document.createElement('div'); el.textContent=d; el.className='dow'; calDOW.appendChild(el); });
      calGrid.innerHTML=''; dayDrawer.classList.remove('active');
      const start = startOfMonthWithMondayGrid(base);
      for (let i=0;i<42;i++){
        const d = new Date(start); d.setDate(start.getDate()+i); const ds = toDateStr(d);
        const el = document.createElement('div'); el.className='day'; if (ds===toDateStr(new Date())) el.classList.add('today');

        // Background big bars
        const worked = workMins(ds), comp = compMins(ds);
        const pct = v => Math.max(0, Math.min(100, v));
        const leftWork = pct((worked / TARGET) * 100);
        const leftCombined = pct(((worked + comp) / TARGET) * 100);
        const leftComp = Math.max(0, leftCombined - leftWork);
        const delta = dayBankDelta(ds);
        const rightOT = pct((Math.max(0, delta) / TARGET) * 100);

        const bars = document.createElement('div'); bars.className='bg-bars';
        const left = document.createElement('div'); left.className='bg-half';
        const g = document.createElement('div'); g.className='fill green'; g.style.width = leftWork + '%';
        const vfill = document.createElement('div'); vfill.className='fill violet'; vfill.style.left = leftWork + '%'; vfill.style.width = leftComp + '%';
        left.appendChild(g); if (leftComp>0) left.appendChild(vfill);
        const right = document.createElement('div'); right.className='bg-half';
        const r = document.createElement('div'); r.className='fill red'; r.style.width = rightOT + '%';
        if (rightOT>0) right.appendChild(r);
        bars.appendChild(left); bars.appendChild(right);
        el.appendChild(bars);

        // Foreground labels
        const pctCenter = Math.round(Math.max(0, Math.min(1, (worked + comp) / TARGET)) * 100);
        el.innerHTML += `<span class="n">${d.getDate()}</span><div class="pct">${pctCenter}%</div>`;
        if (worked){ const hh=document.createElement('span'); hh.className='h'; hh.textContent=fmtHM(worked); el.appendChild(hh); }
        else if (comp){ const hh=document.createElement('span'); hh.className='h'; hh.textContent='+'+fmtHM(comp); el.appendChild(hh); }

        el.addEventListener('click', ()=>openDayDrawer(ds)); calGrid.appendChild(el);
      }
      // footer: month hours + bank
      const totalH = fmtHM(monthWorkedMins(base.getFullYear(), base.getMonth()));
      const bank = fmtSignedHM(overtimeBank());
      calFooter.innerHTML = `<strong>Month hours:</strong> ${totalH} · <strong>Overtime bank:</strong> ${bank}`;
    }

    function openDayDrawer(ds){
      const w = workMins(ds);
      const c = compMins(ds);
      const completion = completionPct(ds);
      const delta = dayBankDelta(ds);

      let html = `<div class="muted" style="margin-bottom:6px"><strong>${ds}</strong>${isHoliday(ds)?' • Public holiday':''}</div>`;
      html += `<div class="group" style="margin-top:0">
        <div class="row" style="display:flex; gap:8px; flex-wrap:wrap;">
          <div class="pill">Worked: ${fmtHM(w)}</div>
          <div class="pill">Comp: ${fmtHM(c)}</div>
          <div class="pill">Day impact: ${fmtSignedHM(delta)}</div>
        </div>
        <div class="bars" style="display:flex; gap:8px; margin-top:10px;">
          <div class="bar" style="position:relative;">
            <div class="fill green" style="width:${Math.max(0, Math.min(100, w/TARGET*100))}%"></div>
            <div class="fill violet" style="left:${Math.max(0, Math.min(100, w/TARGET*100))}%; width:${Math.max(0, Math.min(100, (w+c)/TARGET*100) - Math.max(0, Math.min(100, w/TARGET*100)))}%"></div>
            <div class="label">${Math.round(completion*100)}%</div>
          </div>
          <div class="bar"><div class="fill red" style="width:${Math.max(0, Math.min(100, Math.max(0, delta)/TARGET*100))}%"></div><div class="label">${fmtSignedHM(delta)}</div></div>
        </div>
        <div class="row" style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn" id="drawerEdit">Edit work</button>
          <button class="btn" id="drawerEditComp">Edit compensation</button>
          <button class="btn danger" id="drawerReset">Reset this day</button>
        </div>
      </div>`;

      document.getElementById('dayDrawer').innerHTML = html; document.getElementById('dayDrawer').classList.add('active');
      document.getElementById('drawerEdit').onclick = ()=>{ document.getElementById('logDate').value = ds; loadDayIntoLogger(ds); show('logger'); };
      document.getElementById('drawerEditComp').onclick = ()=>{ document.getElementById('compDate').value = ds; loadCompIntoForm(ds); show('comp'); };
      document.getElementById('drawerReset').onclick = ()=>{ delete state.work[ds]; delete state.comp[ds]; save(); renderMenu(); renderCalendar(); document.getElementById('dayDrawer').classList.remove('active'); };
    }

    document.getElementById('calPrev').addEventListener('click', ()=>{ monthOffset--; renderCalendar(); });
    document.getElementById('calNext').addEventListener('click', ()=>{ monthOffset++; renderCalendar(); });
    document.getElementById('calToday').addEventListener('click', ()=>{ monthOffset=0; renderCalendar(); });

    // ---- Logger with breaks (one session/day) ----
    function nowHHMM(){ const n=new Date(); return `${pad(n.getHours())}:${pad(n.getMinutes())}`; }
    function parseHHMM(t){ const [h,m]=t.split(':').map(Number); return h*60 + m; }
    function validTime(t){ return /^\d{2}:\d{2}$/.test(t); }
    const breaksPane = document.getElementById('breaksPane');

    function computeTotal(){
      const a = document.getElementById('startTime').value.trim(); const b = document.getElementById('stopTime').value.trim();
      if (!validTime(a) || !validTime(b)) { document.getElementById('computedTotal').textContent = '0h 00m'; return 0; }
      let work = parseHHMM(b) - parseHHMM(a); if (work<0) work += 24*60;
      let breakTotal = 0; breaksPane.querySelectorAll('.break-item').forEach(it=>{ const s=it.querySelector('.bi-start').value.trim(); const e=it.querySelector('.bi-stop').value.trim(); if (validTime(s)&&validTime(e)){ let mins=parseHHMM(e)-parseHHMM(s); if (mins>0) breakTotal += mins; } });
      const net = Math.max(0, work - breakTotal); document.getElementById('computedTotal').textContent = fmtHM(net); return net;
    }
    function addBreakRow(initial={name:'', start:'', stop:''}){
      const row = document.createElement('div'); row.className='break-item'; row.innerHTML = `
        <div><small>Name</small><input type="text" class="bi-name" placeholder="Lunch / Errand" value="${initial.name||''}"></div>
        <div><small>Start</small><input type="time" class="bi-start" value="${initial.start||''}"></div>
        <div><small>Stop</small><input type="time" class="bi-stop" value="${initial.stop||''}"></div>
        <div><button class="btn danger bi-del">Remove</button></div>`;
      breaksPane.appendChild(row); document.getElementById('breaksPane').classList.add('active');
      row.querySelectorAll('input').forEach(inp=>inp.addEventListener('input', computeTotal));
      row.querySelector('.bi-del').addEventListener('click', ()=>{ row.remove(); if(!breaksPane.querySelector('.break-item')) breaksPane.classList.remove('active'); computeTotal(); });
      computeTotal();
    }
    function clearLoggerFor(ds){
      document.getElementById('startTime').value=''; document.getElementById('stopTime').value='';
      breaksPane.innerHTML=''; breaksPane.classList.remove('active');
      document.getElementById('computedTotal').textContent='0h 00m';
      const w = state.work[ds];
      document.getElementById('holidayFlag').checked = !!(w && w.holiday);
      if (w){
        document.getElementById('startTime').value = w.start||'';
        document.getElementById('stopTime').value = w.stop||'';
        (w.breaks||[]).forEach(b=>addBreakRow(b));
        computeTotal();
      }
    }
    function loadDayIntoLogger(ds){
      document.getElementById('logDate').value = ds;
      clearLoggerFor(ds);
    }
    function renderLogger(){
      const dateInput = document.getElementById('logDate');
      if (!dateInput.value) dateInput.value = toDateStr(new Date());
      clearLoggerFor(dateInput.value);
    }
    document.getElementById('logDate').addEventListener('change', (e)=>{
      const ds = e.target.value; clearLoggerFor(ds);
    });

    document.getElementById('btnStartNow').addEventListener('click', ()=>{ document.getElementById('startTime').value = nowHHMM(); computeTotal(); });
    document.getElementById('btnStopNow').addEventListener('click',  ()=>{ document.getElementById('stopTime').value  = nowHHMM(); computeTotal(); });
    document.getElementById('btnAddBreak').addEventListener('click', ()=> addBreakRow());
    document.getElementById('startTime').addEventListener('input', computeTotal);
    document.getElementById('stopTime').addEventListener('input', computeTotal);

    document.getElementById('btnSave').addEventListener('click', ()=>{
      const ds = document.getElementById('logDate').value || toDateStr(new Date());
      const a = document.getElementById('startTime').value.trim();
      const b = document.getElementById('stopTime').value.trim();
      if (!validTime(a) || !validTime(b)) { alert('Enter both start and stop times'); return; }
      const net = computeTotal();
      const breaks=[];
      document.querySelectorAll('#breaksPane .break-item').forEach(it=>{ breaks.push({ name: it.querySelector('.bi-name').value.trim(), start: it.querySelector('.bi-start').value.trim(), stop: it.querySelector('.bi-stop').value.trim() }); });
      const holiday = document.getElementById('holidayFlag').checked;
      state.work[ds] = { start:a, stop:b, breaks, netMins: net, holiday };
      save(); renderMenu(); renderCalendar(); show('menu');
    });

    document.getElementById('btnResetWork').addEventListener('click', ()=>{
      const ds = document.getElementById('logDate').value || toDateStr(new Date());
      if (state.work[ds]) { delete state.work[ds]; save(); }
      clearLoggerFor(ds); renderMenu(); renderCalendar();
    });

    // ---- Compensation ----
    function renderComp(){
      const ds = document.getElementById('compDate').value || toDateStr(new Date());
      if (!document.getElementById('compDate').value) document.getElementById('compDate').value = ds;
      document.getElementById('compBalance').textContent = "Overtime bank: " + fmtSignedHM(overtimeBank());
    }
    function loadCompIntoForm(ds){
      const c = state.comp[ds];
      if (c){
        document.getElementById('compDate').value = ds;
        document.getElementById('compHours').value = Math.floor((c.mins||0)/60);
        document.getElementById('compMinutes').value = (c.mins||0)%60;
        document.getElementById('compNote').value = c.note||'';
      } else {
        document.getElementById('compHours').value = 0;
        document.getElementById('compMinutes').value = 0;
        document.getElementById('compNote').value = '';
      }
    }
    document.getElementById('btnFullDay').addEventListener('click', ()=>{ document.getElementById('compHours').value = 8; document.getElementById('compMinutes').value = 24; });
    document.getElementById('btnSaveComp').addEventListener('click', ()=>{
      const ds = document.getElementById('compDate').value || toDateStr(new Date());
      const hours = Math.max(0, parseInt(document.getElementById('compHours').value||'0',10));
      const minutes = Math.max(0, parseInt(document.getElementById('compMinutes').value||'0',10)) % 60;
      const mins = hours*60 + minutes;
      const note = document.getElementById('compNote').value.trim();
      if (!mins){ alert('Enter hours/minutes to compensate'); return; }
      state.comp[ds] = { mins, note };
      save(); renderMenu(); renderCalendar(); show('menu');
    });
    document.getElementById('btnResetComp').addEventListener('click', ()=>{
      const ds = document.getElementById('compDate').value || toDateStr(new Date());
      if (state.comp[ds]) { delete state.comp[ds]; save(); }
      renderMenu(); renderCalendar(); loadCompIntoForm(ds);
    });

    // ---- Boot ----
    (function boot(){
      show('menu');
      if ('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js');
    })();
  </script>
</body>
</html>
