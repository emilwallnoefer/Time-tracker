<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hour Logger</title>

  <!-- PWA essentials -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root { --pad: 16px; --radius: 16px; --bg: #fafafa; --card: #ffffff; --muted: #6b7280; --text: #111827; }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: -apple-system, system-ui, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); }

    /* Top bar */
    .topbar { position: sticky; top: 0; display: flex; align-items: center; gap: 8px; padding: 12px var(--pad); background: #fff; border-bottom: 1px solid #eee; z-index: 10; }
    .back { border: 1px solid #e5e7eb; background: #fff; border-radius: 12px; padding: 8px 12px; font-size: 14px; }
    .title { font-weight: 700; font-size: 18px; margin-left: 4px; }
    .spacer { flex: 1; }
    .pill { display: inline-block; padding: 4px 10px; border: 1px solid #e5e7eb; border-radius: 999px; font-size: 12px; color: #374151; background: #fff; }

    /* Views */
    .view { display: none; padding: var(--pad); }
    .view.active { display: block; }

    /* Menu */
    .hero { position: relative; height: 28vh; min-height: 160px; border-radius: 24px; overflow: hidden; background: radial-gradient(80% 80% at 50% 30%, #eef6ff, #fff); border: 1px solid #eef2f7; box-shadow: 0 1px 4px rgba(0,0,0,.06); display: flex; align-items: center; justify-content: center; }
    .hero::after { content: ""; position: absolute; inset: 0; background-image: url('icon-512.png'); background-size: 60%; background-position: center; background-repeat: no-repeat; opacity: .06; }
    .hero h1 { position: relative; z-index: 1; font-size: 24px; margin: 0; }

    .cards { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 14px; }
    .card { background: var(--card); border: 1px solid #eee; border-radius: 18px; padding: 16px; display: flex; align-items: center; gap: 12px; box-shadow: 0 1px 3px rgba(0,0,0,.05); }
    .card h3 { margin: 0; font-size: 18px; }
    .card p { margin: 4px 0 0; color: var(--muted); font-size: 14px; }
    .card button { margin-left: auto; border: 1px solid #111; background: #111; color: #fff; border-radius: 12px; padding: 10px 14px; }

    /* Logger */
    .group { background: var(--card); border: 1px solid #eee; border-radius: 16px; padding: 14px; margin-bottom: 12px; }
    label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    input[type="time"], input[type="date"], input[type="text"], input[type="number"] { width: 100%; border: 1px solid #e5e7eb; border-radius: 12px; padding: 10px; font-size: 16px; }
    .row-logger { display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: end; }
    .btn { border: 1px solid #e5e7eb; background: #fff; border-radius: 12px; padding: 10px 14px; font-size: 15px; }
    .btn.primary { background: #111; border-color: #111; color: #fff; }
    .btn.danger { border-color: #ef4444; color: #ef4444; }
    .btn.secondary { border-color: #111; color: #111; }

    @media (max-width: 480px){
      .row-logger { grid-template-columns: 1fr; }
    }

    /* Calendar */
    .cal-wrap { background: var(--card); border: 1px solid #eee; border-radius: 16px; padding: 10px; }
    .cal-head { display: flex; align-items: center; gap: 8px; padding: 8px; flex-wrap: wrap; }
    .cal-title { font-weight: 700; }
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; padding: 8px; }
    .dow { text-align: center; font-size: 12px; color: var(--muted); }
    .day { border: 1px solid #eee; border-radius: 12px; padding: 8px; min-height: 76px; position: relative; background: #fff; cursor: pointer; }
    .day .n { position: absolute; top: 8px; left: 8px; font-size: 12px; color: #6b7280; }
    .day .h { position: absolute; bottom: 6px; right: 8px; font-weight: 700; font-size: 12px; color: #111; }
    .day .ot { position: absolute; bottom: 6px; left: 8px; font-size: 11px; }
    .day.today { outline: 2px solid #111; }
    .cal-info { padding: 10px; border-top: 1px dashed #e5e7eb; font-size: 14px; }
    .cal-info h4 { margin: 6px 0; }

    /* Day detail bars */
    .day-bars { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    .box { position: relative; height: 56px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; }
    .fill { position: absolute; top: 0; bottom: 0; width: 0; }
    .green { background: #bbf7d0; }
    .violet { background: #e9d5ff; }
    .red { background: #fecaca; }
    .box .center { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-weight: 700; }
    .box .label { position: absolute; top: 6px; left: 8px; font-size: 12px; color: #6b7280; }

    /* Breaks */
    .breaks { display: none; margin-top: 10px; }
    .breaks.active { display: block; }
    .break-item { display: grid; grid-template-columns: 1.2fr 1fr 1fr auto; gap: 8px; align-items: end; margin-bottom: 8px; }
    .break-item small { color: var(--muted); display:block; margin-bottom:4px; }
    .muted { color: var(--muted); font-size: 13px; }
    .total { display: flex; justify-content: space-between; align-items: center; padding-top: 6px; }
  </style>
</head>
<body>
  <div class="topbar">
    <button class="back" id="btnBack" style="visibility:hidden">◀︎ Back</button>
    <div class="title">Hour Logger</div>
    <div class="spacer"></div>
    <span class="pill" id="pillToday">—</span>
  </div>

  <!-- MENU VIEW -->
  <section id="view-menu" class="view active">
    <div class="hero"><h1>Track your day</h1></div>

    <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
      <span class="pill" id="pillTodayHours">Today: 0 h</span>
      <span class="pill" id="pillMonthHours">This month: 0 h</span>
      <span class="pill" id="pillMonthOT">Month OT: 0 h</span>
    </div>

    <div class="cards">
      <!-- Today's logging FIRST -->
      <div class="card">
        <div>
          <h3 id="todayCardTitle">Today's logging</h3>
          <p>Set start/stop, add breaks, and save.</p>
        </div>
        <button id="goLogger">Log</button>
      </div>

      <!-- Calendar second -->
      <div class="card">
        <div>
          <h3>Calendar</h3>
          <p>Review, edit any day, and see overtime vs target.</p>
        </div>
        <button id="goCalendar">Open</button>
      </div>

      <!-- Compensate overtime -->
      <div class="card">
        <div>
          <h3>Compensate overtime</h3>
          <p>Reduce your overtime balance by recording paid time off. See your current balance below.</p>
        </div>
        <button id="openComp">Adjust</button>
      </div>
    </div>
  </section>

  <!-- CALENDAR VIEW -->
  <section id="view-calendar" class="view">
    <div class="cal-wrap">
      <div class="cal-head">
        <button class="btn" id="calPrev">◀︎</button>
        <div class="cal-title" id="calTitle">Month YYYY</div>
        <button class="btn" id="calNext">▶︎</button>
        <div class="spacer"></div>
        <label class="muted">Daily target</label>
        <input id="dailyTarget" type="time" step="60" style="width:120px" />
        <button class="btn" id="calToday">Today</button>
      </div>
      <div class="cal-grid" id="calDOW"></div>
      <div class="cal-grid" id="calGrid"></div>
      <div class="cal-info" id="calInfo"></div>
    </div>
  </section>

  <!-- LOGGER VIEW -->
  <section id="view-logger" class="view">
    <div class="group">
      <label>Date</label>
      <input type="date" id="logDate" />
    </div>

    <div class="group">
      <div class="row-logger">
        <div>
          <label><strong>Start</strong></label>
          <input type="time" id="startTime" />
          <button class="btn" id="btnStartNow" style="margin-top:8px; width:100%">Start now</button>
        </div>
        <div style="text-align:center">
          <button class="btn" id="btnAddBreak">+ Add break</button>
          <div class="breaks" id="breaksPane"></div>
        </div>
        <div>
          <label><strong>Stop</strong></label>
          <input type="time" id="stopTime" />
          <button class="btn" id="btnStopNow" style="margin-top:8px; width:100%">Stop now</button>
        </div>
      </div>
      <div class="total">
        <span class="muted">Net working time (breaks subtracted)</span>
        <strong id="computedTotal">0.00 h</strong>
      </div>
    </div>

    <div class="group">
      <button class="btn primary" id="btnSave">Save</button>
      <button class="btn danger" id="btnDelete">Delete day</button>
    </div>
  </section>

  <!-- COMPENSATION DIALOG (inline) -->
  <section id="view-comp" class="view">
    <div class="group">
      <label>Date</label>
      <input type="date" id="compDate" />
    </div>
    <div class="group">
      <label>Compensate duration (hh:mm)</label>
      <div style="display:flex; gap:8px; flex-wrap: wrap;">
        <input type="time" id="compDur" step="60" style="max-width:160px" />
        <input type="text" id="compReason" placeholder="Reason (optional)" />
      </div>
      <div id="compInfo" class="muted" style="margin-top:8px;"></div>
      <p class="muted" style="margin-top:8px;">This will <strong>reduce</strong> your overtime balance by the duration you enter.</p>
      <button class="btn primary" id="btnCompSave">Apply compensation</button>
    </div>
  </section>

  <script>
    // ---- Persistence / Migration ----
    const KEY = 'hourlogger.v4';
    const raw = localStorage.getItem(KEY) || localStorage.getItem('hourlogger.v3') || localStorage.getItem('hourlogger.v2') || localStorage.getItem('hourlogger.v1');
    const state = raw ? JSON.parse(raw) : {};
    state.records ||= {}; // { 'YYYY-MM-DD': {start:'HH:MM', stop:'HH:MM', breaks:[{name,start,stop}], compMins: number} }
    state.settings ||= { dailyTarget: '08:24' };
    if (state.entries) { // migrate legacy totals-only
      state.entries.forEach(e => {
        const mins = Math.round((e.hours || 0) * 60);
        const rec = state.records[e.date] || { breaks: [], compMins: 0 };
        rec._netMins = (rec._netMins || 0) + mins;
        state.records[e.date] = rec;
      });
      delete state.entries;
    }
    function persist(){ localStorage.setItem(KEY, JSON.stringify(state)); }

    // ---- Helpers ----
    const pad = n => String(n).padStart(2,'0');
    const toDateStr = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const fromDateStr = s => { const [y,m,da]=s.split('-').map(Number); return new Date(y, m-1, da); };
    const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    const dows = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    const validTime = t => /^\d{2}:\d{2}$/.test(t);
    const parseHHMM = t => { const [h,m]=t.split(':').map(Number); return h*60 + m; };

    function workMinsFor(rec){
      let work = 0;
      if (rec && rec.start && rec.stop && validTime(rec.start) && validTime(rec.stop)) {
        work = parseHHMM(rec.stop) - parseHHMM(rec.start);
        if (work < 0) work += 24*60;
        let breaks = 0;
        (rec.breaks||[]).forEach(b=>{
          if (validTime(b.start) && validTime(b.stop)) {
            let m = parseHHMM(b.stop) - parseHHMM(b.start);
            if (m > 0) breaks += m;
          }
        });
        work = Math.max(0, work - breaks);
      } else if (rec && rec._netMins) {
        work = rec._netMins;
      }
      return work;
    }

    function overtimeFor(dateStr){
      const target = validTime(state.settings.dailyTarget) ? parseHHMM(state.settings.dailyTarget) : 504;
      const rec = state.records[dateStr];
      const net = workMinsFor(rec);
      const comp = rec && rec.compMins ? rec.compMins : 0;
      return (net - target) - comp;
    }

    function sumMonth(date){
      const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
      const monthEnd = new Date(date.getFullYear(), date.getMonth()+1, 0);
      let work = 0, comp = 0, days=0;
      for (let d=new Date(monthStart); d<=monthEnd; d.setDate(d.getDate()+1)){
        const ds = toDateStr(d);
        const rec = state.records[ds];
        if (rec) {
          work += workMinsFor(rec);
          comp += rec.compMins || 0;
          days++;
        }
      }
      const target = validTime(state.settings.dailyTarget) ? parseHHMM(state.settings.dailyTarget) : 504;
      const ot = (work - days*target) - comp;
      return { work, comp, ot, days, target };
    }

    function totalOvertimeAll(){
      let work=0, comp=0, days=0;
      const target = validTime(state.settings.dailyTarget) ? parseHHMM(state.settings.dailyTarget) : 504;
      Object.keys(state.records).forEach(ds=>{
        work += workMinsFor(state.records[ds]);
        comp += state.records[ds].compMins || 0;
        days += 1;
      });
      return (work - days*target) - comp;
    }

    // ---- View management ----
    const views = { menu: document.getElementById('view-menu'), calendar: document.getElementById('view-calendar'), logger: document.getElementById('view-logger'), comp: document.getElementById('view-comp') };
    const btnBack = document.getElementById('btnBack');
    function show(name){
      Object.values(views).forEach(v=>v.classList.remove('active'));
      views[name].classList.add('active');
      btnBack.style.visibility = (name==='menu') ? 'hidden' : 'visible';
      if (name==='menu') renderMenu();
      if (name==='calendar') renderCalendar();
      if (name==='logger') renderLogger();
      if (name==='comp') renderComp();
    }
    btnBack.addEventListener('click', ()=>show('menu'));

    // ---- Menu ----
    const pillToday = document.getElementById('pillToday');
    const pillTodayHours = document.getElementById('pillTodayHours');
    const pillMonthHours = document.getElementById('pillMonthHours');
    const pillMonthOT = document.getElementById('pillMonthOT');
    const todayCardTitle = document.getElementById('todayCardTitle');

    function renderMenu(){
      const now = new Date();
      const dStr = toDateStr(now);
      pillToday.textContent = dStr;
      todayCardTitle.textContent = "Today's logging";
      const rec = state.records[dStr];
      const h = workMinsFor(rec)/60;
      pillTodayHours.textContent = `Today: ${h.toFixed(2)} h`;
      const { work, ot } = sumMonth(now);
      pillMonthHours.textContent = `This month: ${(work/60).toFixed(1)} h`;
      pillMonthOT.textContent = `Month OT: ${(ot/60).toFixed(1)} h`;
    }

    document.getElementById('goCalendar').addEventListener('click', ()=>show('calendar'));
    document.getElementById('goLogger').addEventListener('click', ()=>{ document.getElementById('logDate').value = toDateStr(new Date()); show('logger'); });
    document.getElementById('openComp').addEventListener('click', ()=>show('comp'));

    // ---- Calendar ----
    const calTitle = document.getElementById('calTitle');
    const calDOW = document.getElementById('calDOW');
    const calGrid = document.getElementById('calGrid');
    const calInfo = document.getElementById('calInfo');
    const dailyTargetInput = document.getElementById('dailyTarget');
    let monthOffset = 0;

    function startOfMonthWithMondayGrid(date){
      const first = new Date(date.getFullYear(), date.getMonth(), 1);
      const day = (first.getDay() + 6) % 7; // Monday=0
      first.setDate(first.getDate() - day);
      first.setHours(0,0,0,0);
      return first;
    }

    function renderCalendar(selectedDate){
      const base = new Date(); base.setMonth(base.getMonth()+monthOffset);
      const monthName = monthNames[base.getMonth()];
      calTitle.textContent = `${monthName} ${base.getFullYear()}`;
      dailyTargetInput.value = state.settings.dailyTarget || '08:24';

      // DOW header
      calDOW.innerHTML = '';
      dows.forEach(d=>{ const el=document.createElement('div'); el.textContent=d; el.className='dow'; calDOW.appendChild(el); });

      // Grid
      calGrid.innerHTML='';
      const start = startOfMonthWithMondayGrid(base);
      for (let i=0;i<42;i++){
        const d = new Date(start); d.setDate(start.getDate()+i);
        const ds = toDateStr(d);
        const el = document.createElement('div'); el.className='day';
        if (ds===toDateStr(new Date())) el.classList.add('today');
        el.innerHTML = `<span class="n">${d.getDate()}</span>`;
        const rec = state.records[ds];
        const net = workMinsFor(rec);
        if (net>0) {
          const hh = document.createElement('span'); hh.className='h'; hh.textContent = (net/60).toFixed(1) + ' h'; el.appendChild(hh);
          const ot = overtimeFor(ds);
          const otEl = document.createElement('span'); otEl.className='ot'; otEl.textContent = (ot>=0?'+':'') + (ot/60).toFixed(1) + 'h';
          otEl.style.color = ot>=0 ? '#16a34a' : '#ef4444';
          el.appendChild(otEl);
        }
        el.addEventListener('click', ()=>{
          showDayDetails(ds);
        });
        calGrid.appendChild(el);
      }
      if (selectedDate) showDayDetails(selectedDate); else calInfo.innerHTML = '<em class="muted">Tap a day to see details and edit.</em>';
    }

    function showDayDetails(dateStr){
      const rec = state.records[dateStr] || { breaks: [], compMins: 0 };
      const target = validTime(state.settings.dailyTarget) ? parseHHMM(state.settings.dailyTarget) : 504;
      const net = workMinsFor(rec);
      const comp = rec.compMins || 0;
      const ot = (net - target) - comp;
      const completePct = Math.max(0, Math.min(100, Math.round((net/target)*100)));
      const compPct = Math.max(0, Math.min(100, Math.round((comp/target)*100)));
      const otPct = ot > 0 ? Math.max(0, Math.min(100, Math.round((ot/target)*100))) : 0;

      let html = `<h4>${dateStr}</h4>`;
      html += `<div>Start–Stop: <strong>${rec.start||'—'} – ${rec.stop||'—'}</strong></div>`;
      if ((rec.breaks||[]).length){
        html += '<div>Breaks:</div><ul>';
        rec.breaks.forEach(b=>{ html += `<li>${b.name||'Break'}: ${b.start||'—'}–${b.stop||'—'}</li>`; });
        html += '</ul>';
      } else {
        html += '<div class="muted">No breaks recorded.</div>';
      }
      if (comp) html += `<div>Compensated: <strong>${(comp/60).toFixed(2)} h</strong></div>`;
      html += `<div>Worked: <strong>${(net/60).toFixed(2)} h</strong> &nbsp; Target: ${state.settings.dailyTarget} &nbsp; OT: <strong style="color:${ot>=0?'#16a34a':'#ef4444'}">${(ot/60).toFixed(2)} h</strong></div>`;

      // Bars: left=completion (green) + compensation (violet) overlay; right=overtime (red)
      html += `
        <div class="day-bars">
          <div class="box" id="boxLeft">
            <div class="label">Work % of target</div>
            <div class="fill green" style="width:${completePct}%"></div>
            ${compPct>0 ? `<div class="fill violet" style="width:${compPct}%"></div>` : ''}
            <div class="center">${completePct}%${compPct>0 ? ` + ${compPct}% comp` : ''}</div>
          </div>
          <div class="box" id="boxRight">
            <div class="label">Overtime</div>
            <div class="fill red" style="width:${otPct}%"></div>
            <div class="center">${ot>0 ? (ot/60).toFixed(2)+' h' : '0 h'}</div>
          </div>
        </div>
        <div style="margin-top:8px;"><button class="btn secondary" id="editDayBtn">Edit this day</button></div>
      `;

      calInfo.innerHTML = html;
      document.getElementById('editDayBtn').addEventListener('click', ()=>{
        document.getElementById('logDate').value = dateStr;
        loadRecordIntoLogger(dateStr);
        show('logger');
      });
    }

    document.getElementById('calPrev').addEventListener('click', ()=>{ monthOffset--; renderCalendar(); });
    document.getElementById('calNext').addEventListener('click', ()=>{ monthOffset++; renderCalendar(); });
    document.getElementById('calToday').addEventListener('click', ()=>{ monthOffset=0; renderCalendar(toDateStr(new Date())); });
    dailyTargetInput.addEventListener('change', ()=>{
      if (!validTime(dailyTargetInput.value)) { alert('Enter target like 08:24'); return; }
      state.settings.dailyTarget = dailyTargetInput.value;
      persist(); renderCalendar();
    });

    // ---- Logger (with edit) ----
    const breaksPane = document.getElementById('breaksPane');

    function nowHHMM(){ const n=new Date(); return pad(n.getHours()) + ':' + pad(n.getMinutes()); }

    function computeTotal(){
      const a = document.getElementById('startTime').value.trim();
      const b = document.getElementById('stopTime').value.trim();
      if (!validTime(a) || !validTime(b)) { document.getElementById('computedTotal').textContent = '0.00 h'; return 0; }
      let work = parseHHMM(b) - parseHHMM(a);
      if (work < 0) work += 24*60;
      let breakTotal = 0;
      breaksPane.querySelectorAll('.break-item').forEach(it=>{
        const s = it.querySelector('.bi-start').value.trim();
        const e = it.querySelector('.bi-stop').value.trim();
        if (validTime(s) && validTime(e)) {
          let mins = parseHHMM(e) - parseHHMM(s);
          if (mins > 0) breakTotal += mins;
        }
      });
      const net = Math.max(0, work - breakTotal);
      document.getElementById('computedTotal').textContent = (net/60).toFixed(2) + ' h';
      return net;
    }

    function addBreakRow(initial={name:'', start:'', stop:''}){
      breaksPane.classList.add('active');
      const row = document.createElement('div');
      row.className = 'break-item';
      row.innerHTML = `
        <div>
          <small>Name</small>
          <input type="text" class="bi-name" placeholder="Lunch / Errand" value="${initial.name||''}">
        </div>
        <div>
          <small>Start</small>
          <input type="time" class="bi-start" value="${initial.start||''}">
        </div>
        <div>
          <small>Stop</small>
          <input type="time" class="bi-stop" value="${initial.stop||''}">
        </div>
        <div>
          <button class="btn danger bi-del">Remove</button>
        </div>`;
      breaksPane.appendChild(row);
      row.querySelectorAll('input').forEach(inp=>inp.addEventListener('input', computeTotal));
      row.querySelector('.bi-del').addEventListener('click', ()=>{ row.remove(); if (!breaksPane.querySelector('.break-item')) breaksPane.classList.remove('active'); computeTotal(); });
      computeTotal();
    }

    document.getElementById('btnAddBreak').addEventListener('click', ()=>addBreakRow());
    document.getElementById('startTime').addEventListener('input', computeTotal);
    document.getElementById('stopTime').addEventListener('input', computeTotal);
    document.getElementById('btnStartNow').addEventListener('click', ()=>{ document.getElementById('startTime').value = nowHHMM(); computeTotal(); });
    document.getElementById('btnStopNow').addEventListener('click', ()=>{ document.getElementById('stopTime').value = nowHHMM(); computeTotal(); });

    function loadRecordIntoLogger(dateStr){
      const rec = state.records[dateStr];
      document.getElementById('logDate').value = dateStr;
      breaksPane.innerHTML = ''; breaksPane.classList.remove('active');
      document.getElementById('startTime').value = rec && rec.start ? rec.start : '';
      document.getElementById('stopTime').value = rec && rec.stop ? rec.stop : '';
      (rec && rec.breaks ? rec.breaks : []).forEach(b=>addBreakRow(b));
      computeTotal();
    }

    function renderLogger(){
      const ds = document.getElementById('logDate').value || toDateStr(new Date());
      document.getElementById('logDate').value = ds;
      loadRecordIntoLogger(ds);
    }

    document.getElementById('logDate').addEventListener('change', ()=>renderLogger());

    document.getElementById('btnSave').addEventListener('click', ()=>{
      const dateStr = document.getElementById('logDate').value || toDateStr(new Date());
      const start = document.getElementById('startTime').value.trim();
      const stop = document.getElementById('stopTime').value.trim();
      if (!validTime(start) || !validTime(stop)) { alert('Please enter both start and stop times.'); return; }
      const breaks = [];
      breaksPane.querySelectorAll('.break-item').forEach(it=>{
        breaks.push({ name: it.querySelector('.bi-name').value.trim(), start: it.querySelector('.bi-start').value, stop: it.querySelector('.bi-stop').value });
      });
      const existing = state.records[dateStr] || { compMins: 0 };
      state.records[dateStr] = { start, stop, breaks, compMins: existing.compMins || 0 };
      persist();
      show('menu');
    });

    document.getElementById('btnDelete').addEventListener('click', ()=>{
      const ds = document.getElementById('logDate').value;
      if (state.records[ds]) { delete state.records[ds]; persist(); }
      show('menu');
    });

    // ---- Compensation ----
    function renderComp(){
      const ds = toDateStr(new Date());
      document.getElementById('compDate').value = ds;
      document.getElementById('compDur').value = '01:00';
      document.getElementById('compReason').value = '';
      updateCompInfo();
    }

    function sumAllDays(){
      let totalWork=0, totalComp=0, days=0;
      const target = validTime(state.settings.dailyTarget) ? parseHHMM(state.settings.dailyTarget) : 504;
      Object.keys(state.records).forEach(ds=>{
        totalWork += workMinsFor(state.records[ds]);
        totalComp += state.records[ds].compMins || 0;
        days += 1;
      });
      return { totalWork, totalComp, days, target };
    }

    function updateCompInfo(){
      const compInfo = document.getElementById('compInfo');
      const ds = document.getElementById('compDate').value || toDateStr(new Date());
      const now = fromDateStr(ds);
      const m = sumMonth(now);
      const overall = totalOvertimeAll();
      compInfo.innerHTML = \`Overtime balance — <strong>Month:</strong> \${(m.ot/60).toFixed(2)} h, <strong>All-time:</strong> \${(overall/60).toFixed(2)} h\;
    }

    document.getElementById('compDate').addEventListener('change', updateCompInfo);
    document.getElementById('btnCompSave').addEventListener('click', ()=>{
      const ds = document.getElementById('compDate').value || toDateStr(new Date());
      const dur = document.getElementById('compDur').value;
      if (!validTime(dur)) { alert('Enter duration like 01:30'); return; }
      const mins = parseHHMM(dur);
      const rec = state.records[ds] || { breaks: [], compMins: 0 };
      rec.compMins = (rec.compMins || 0) + mins; // reduce overtime
      state.records[ds] = rec;
      persist();
      updateCompInfo();
      alert('Compensation recorded.');
      show('menu');
    });

    // ---- Boot ----
    persist();
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./service-worker.js'); }
  </script>
</body>
</html>
