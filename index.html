<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Hour Logger</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    :root { --pad:16px; --bg:#0b0c0f; --card:#111319; --muted:#9aa3b2; --text:#e8ebf0; --stroke:#1c2030;
            --pill:#151823; --glow:0 0 32px rgba(91,140,255,.08); --accent:#5b8cff; --danger:#ff7a7a; }
    [data-theme="light"] { --bg:#f7f7fb; --card:#ffffff; --muted:#667084; --text:#101828; --stroke:#e5e7eb; --pill:#eef1f5; --glow:0 0 0 rgba(0,0,0,0); }
    [data-theme="dark"]  { --bg:#0b0c0f; --card:#111319; --muted:#9aa3b2; --text:#e8ebf0; --stroke:#1c2030; --pill:#151823; --glow:0 0 32px rgba(91,140,255,.08); }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);position:relative;overflow-x:hidden}
    #fxCanvas{position:fixed;inset:0;z-index:0;pointer-events:none;filter:blur(10px)}
    .fx-top{position:relative;z-index:1;width:100%;margin:0 auto}

    .topbar{position:sticky;top:0;display:flex;gap:10px;align-items:center;padding:10px var(--pad);background:#0f1118aa;border-bottom:1px solid var(--stroke);backdrop-filter:saturate(180%) blur(8px);z-index:10}
    .title{font-weight:800; font-size:18px; text-align:center; flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .btn{border:1px solid var(--stroke);background:#181b24;color:var(--text);border-radius:12px;padding:10px 14px;box-shadow:var(--glow);touch-action:manipulation}
    .btn.small{padding:8px 10px;font-size:12px;border-radius:10px}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .icon-btn{border:1px solid var(--stroke);background:#181b24;border-radius:12px;padding:10px;display:grid;place-items:center; width:40px; height:40px}

    .menu-dd{ position:absolute; top:56px; right:10px; background:var(--card); border:1px solid var(--stroke); border-radius:12px; padding:8px; display:none; box-shadow:0 24px 80px #0006 }
    .menu-dd.show{ display:block; }
    .menu-dd button{ display:block; width:100%; margin:4px 0; }

    .view{display:none;padding:12px var(--pad);position:relative;z-index:1}
    .view.active{display:block;animation:fade .25s ease both}
    @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

    .hero{min-height:92px;border:1px solid var(--stroke);border-radius:18px;display:grid;place-items:center;background:radial-gradient(120% 120% at 10% 0%,rgba(91,140,255,.14),transparent 60%),radial-gradient(120% 120% at 90% 100%,rgba(192,132,252,.16),transparent 60%),var(--card);box-shadow:var(--glow)}
    .cards{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:12px;display:flex;gap:10px;align-items:center;box-shadow:var(--glow)}
    .card h3{margin:0;font-size:15px}
    .card p{margin:2px 0 0;color:var(--muted);font-size:12px;line-height:1.2}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border:1px solid var(--stroke);border-radius:999px;font-size:12px;color:var(--muted);background:var(--pill);box-shadow:var(--glow)}

    .week-card{ background:var(--card); border:1px solid var(--stroke); border-radius:14px; padding:10px; box-shadow:var(--glow); }
    .week-head{ display:grid; grid-template-columns: 1fr auto; align-items:center; gap:8px; }
    .week-title{ font-weight:800; font-size:18px; }
    .week-nav{ display:flex; gap:6px; }
    .week-strip{display:grid;grid-auto-flow:column;grid-auto-columns:minmax(120px,1fr);gap:10px;overflow-x:auto;scroll-snap-type:x mandatory;padding:8px 2px 8px}
    .day-wrap{display:grid;grid-template-rows:auto auto;gap:6px;min-width:120px;max-width:160px}
    .fill-btn{border:1px dashed var(--stroke);background:#0f1118;color:var(--muted);border-radius:10px;padding:8px 10px;font-size:12px;text-align:center}
    .fill-btn.active{border-style:solid;color:var(--text);}
    .day{position:relative;background:var(--card);border:1px solid var(--stroke);border-radius:14px;height:140px;overflow:hidden;scroll-snap-align:start;box-shadow:var(--glow)}
    .day.today{outline:2px solid var(--accent);outline-offset:-2px}
    .day .n{position:absolute;top:8px;left:10px;font-size:11px;font-weight:700;z-index:2;text-shadow:0 2px 6px #0008}
    .day .h{position:absolute;bottom:8px;right:10px;font-weight:700;font-size:11px;z-index:2;text-shadow:0 2px 6px #0008}
    .day .pct{position:absolute;bottom:8px;left:10px;font-weight:700;font-size:11px;z-index:2;opacity:.9;text-shadow:0 2px 6px #0008}
    .day canvas{ position:absolute; inset:0; width:100%; height:100%; z-index:0; pointer-events:none }

    .cal-footer{display:flex;gap:8px;flex-wrap:wrap;padding-top:8px;border-top:1px solid var(--stroke);margin-top:6px;font-size:12px}

    /* Focus bubble and details */
    .focus-layer{position:fixed;inset:0;display:none;z-index:50}
    .focus-layer.active{display:block}
    .backdrop{position:absolute;inset:0;background:#0007;backdrop-filter:blur(10px) saturate(120%)}
    .bubble-date{ position: fixed; top: calc(env(safe-area-inset-top, 0px) + 10px); left: 0; right: 0; text-align:center; font-weight:800; z-index:52 }
    .bubble{position:fixed;border-radius:16px;background:radial-gradient(120% 140% at 20% 10%,rgba(255,255,255,.06),transparent 60%),var(--card);border:1px solid var(--stroke);box-shadow:0 30px 100px #0006,0 0 60px rgba(91,140,255,.15);overflow:hidden;animation:gel .5s cubic-bezier(.2,.8,.2,1) both; z-index:52 }
    @keyframes gel{0%{filter:saturate(.9) blur(.35px)}40%{filter:saturate(1.05) blur(.2px)}100%{filter:saturate(1) blur(0)}}
    .bubble canvas{ position:absolute; inset:0; width:100%; height:100%; }
    .options{position:fixed; display:grid; gap:6px; padding:8px 14px; left: 0; right: 0; z-index:53 }
    .opt-btn{border:1px solid var(--stroke);background:#141824;color:var(--text);border-radius:12px;padding:10px 12px;box-shadow:var(--glow);opacity:0;transform:translateY(8px);animation:pop .35s ease forwards;font-size:14px}
    .opt-btn:nth-child(1){animation-delay:.12s}.opt-btn:nth-child(2){animation-delay:.18s}.opt-btn:nth-child(3){animation-delay:.24s}
    @keyframes pop{to{opacity:1;transform:none}}
    .details{ position:fixed; left:16px; right:16px; background:var(--card); border:1px solid var(--stroke); border-radius:12px; padding:10px; box-shadow:var(--glow); z-index:53; font-size:13px }
    .details h4{ margin:0 0 6px 0; font-size:14px }
    .row{ display:flex; gap:8px; flex-wrap:wrap; justify-content:space-between; }

    /* Logger form ‚Äì dark inputs */
    input[type="time"], input[type="date"], input[type="text"], input[type="number"]{ width:100%; border:1px solid var(--stroke); background:#0f1118; color:var(--text); border-radius:10px; padding:10px; font-size:15px; box-shadow:var(--glow) }
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}

    /* Update banner & version */
    .update-banner{ position: fixed; left: 12px; right:12px; bottom: calc(env(safe-area-inset-bottom,0px) + 12px); background:#0f1a2a; color:#cbe0ff; border:1px solid #163458; border-radius:12px; padding:10px; display:none; align-items:center; justify-content:space-between; gap:8px; z-index:60; box-shadow:0 16px 60px #0008 }
    .update-banner.show{ display:flex }
    .version{ text-align:center; color:var(--muted); font-size:11px; margin:12px 0 6px }
    /* Page centering + safe bottom space */
    .page-wrap{ width:100%; margin: 0 auto; display: grid; gap: 12px; }
    .view{ padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 120px); }
    .card.actions{ position: relative; }
    .card.actions .btn{ min-width: 44%; }
    .card.actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center }
    /* Logger full centering */
    #view-logger .card{ display:grid; justify-items:center; text-align:center }
    #view-logger .card > *{ width:100%; width:100% }
    #view-logger .row{ justify-content:center }
    #view-logger .actions{ justify-content:center }

    .line-stats{ display:flex; gap:8px; flex-wrap:wrap; }
    .version.version-menu{ position: fixed; left: 0; right: 0; bottom: calc(env(safe-area-inset-bottom, 0px) + 8px); text-align:center; z-index: 5; }



    /* Mobile polish */
    @media (max-width:420px){
      .btn{padding:9px 12px}
      .week-strip{grid-auto-columns:minmax(112px,1fr)}
      .day{height:128px}
      .details{left:12px; right:12px}
    }
  
    .toast-wrap{ position:fixed; left:0; right:0; bottom:calc(env(safe-area-inset-bottom,0px) + 18px); display:grid; place-items:center; z-index:80; pointer-events:none }
    .toast{ background:#101826; color:#e8f0ff; border:1px solid #1d2a45; padding:10px 14px; border-radius:12px; box-shadow:0 10px 40px #0008; opacity:0; transform:translateY(10px); transition:.22s ease; font-size:13px; pointer-events:auto }
    .toast.show{ opacity:1; transform:none }
  
/* Limit horizontal scroll to the days strip only */
html, body { overflow-x: hidden; }
.view, .page-wrap { overflow-x: hidden; }
.week-card { overflow: hidden; } /* keep shadows/content inside */
.week-strip{ overflow-x: auto; -webkit-overflow-scrolling: touch; overscroll-behavior-x: contain; }


    /* Holiday overlays */
    .day .holiday{
      position:absolute; inset:0; display:grid; place-items:center;
      font-size:48px; opacity:.98; z-index:1; pointer-events:none;
      text-shadow: 0 2px 8px rgba(0,0,0,.45);
    }
    .holiday-bubble{
      position:absolute; inset:0; display:none; place-items:center;
      font-size:110px; opacity:.98; z-index:2; pointer-events:none;
      text-shadow: 0 8px 24px rgba(0,0,0,.5);
    }
    .holiday-bubble.show{ display:grid; }
    

/* v35 size-only tweaks for logger to prevent overlap */
@media (max-width: 420px){
  .title{ font-size:16px }
  .icon-btn{ width:36px; height:36px; padding:8px }
  .btn{ padding:8px 10px; font-size:13px }
  .btn.small{ padding:7px 9px; font-size:12px }
  #view-logger input[type="time"],
  #view-logger input[type="date"],
  #view-logger input[type="text"],
  #view-logger input[type="number"]{ font-size:14px; padding:9px }
  /* target the inline grid (start/stop) without changing structure */
  #view-logger .card > div[style*="grid-template-columns"]{ gap:8px }
  #view-logger .card > div[style*="grid-template-columns"] > div{ width:100%; margin:0 auto }
  /* action buttons wrap more gracefully */
  .card.actions .btn{ min-width:48% }
}
@media (max-width: 360px){
  #view-logger .card > div[style*="grid-template-columns"] > div{ max-width:150px }
  .card.actions .btn{ min-width:100% }
}


/* v40 breaks full-width minimal layout */
#breaksPane{ width:100%; max-height:300px; overflow:auto; }
.break-item{ display:grid; gap:8px; width:100%; margin:10px 0; }
.break-item .bi-name-block input{ font-size:14px; padding:10px }
.break-item .bi-times{ display:grid; grid-template-columns:1fr 1fr; gap:8px }
.break-item .bi-times input{ width:100%; text-align:center; font-size:14px; padding:10px }
.break-item .bi-remove{ width:100%; padding:10px 12px; }

/* small phones */
@media (max-width:420px){
  .break-item .bi-times{ gap:6px }
  .break-item .bi-name-block input, .break-item .bi-times input{ font-size:13px; padding:9px }
}
@media (max-width:360px){
  .break-item .bi-times{ grid-template-columns:1fr; }
}

</style>
</head>
<body>
  <div class="toast-wrap"><div id="toast" class="toast">Saved</div></div>
  <canvas id="fxCanvas"></canvas>

  <div class="topbar fx-top">
    <button class="icon-btn" id="btnBack" aria-label="Back">‚óÄÔ∏é</button>
    <div class="title">Hour Logger</div>
    <button class="icon-btn" id="btnMenu" aria-label="Menu">‚ò∞</button>
    <div class="menu-dd" id="menuDD">
      <button class="btn small" id="mLight">Light</button>
      <button class="btn small" id="mDark">Dark</button>
    </div>
  </div>

  <!-- MENU -->
  <section id="view-menu" class="view active fx-top"><div class="page-wrap">
    <div class="hero"><h1>Track your day</h1></div>
    <div class="cards">
      <div class="card">
        <div style="flex:1"><h3>Start logging</h3></div>
        <button class="btn primary" id="goLogger">Open</button>
      </div>
      <div class="card">
        <div style="flex:1"><h3>Calendar</h3></div>
        <button class="btn" id="goCalendar">Open</button>
      </div>
      <div class="line-stats"><span class="pill" id="pillWeek">Weekly hours: 0h 00m</span><span class="pill" id="pillBank">Overtime bank: 0h 00m</span></div>
    </div>
    <div class="version version-menu">Hour Logger 40</div>
  </section>

  <!-- CALENDAR -->
  <section id="view-calendar" class="view fx-top"><div class="page-wrap">
    <div class="week-card">
      <div class="week-head">
        <div class="week-title" id="wTitle">‚Äî</div>
        <div class="week-nav">
          <button class="btn small" id="wPrev">‚óÄÔ∏é</button>
          <button class="btn small" id="wToday">Today</button>
          <button class="btn small" id="wNext">‚ñ∂Ô∏é</button>
        </div>
      </div>
      <div id="weekStrip" class="week-strip"></div>
      <div class="cal-footer" id="calFooter"></div>
    </div>
    <div class="version">Hour Logger 40</div>
  </section>

  <!-- LOGGER -->
  <section id="view-logger" class="view fx-top"><div class="page-wrap">
    <div class="card">
      <label>Date</label>
      <input type="date" id="logDate" />
      <div style="margin-top:8px">
        <label style="display:flex;align-items:center;gap:8px;">
          <input type="checkbox" id="holidayFlag" />
          <span>Public holiday (full day)</span>
        </label>
      </div>
    </div>
    <div class="card">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div><label><b>Start</b></label><input type="time" id="startTime"/><button class="btn small" id="btnStartNow" style="margin-top:8px;width:100%">Start now</button></div>
        <div><label><b>Stop</b></label><input type="time" id="stopTime"/><button class="btn small" id="btnStopNow" style="margin-top:8px;width:100%">Stop now</button></div>
        <div style="grid-column:1/-1;display:grid;gap:8px">
          <button class="btn small" id="btnAddBreak">Add break</button>
          <div id="breaksPane" style="width:100%;max-height:220px;overflow:auto"></div>
        </div>
      </div>
      
    </div>
    <div class="card actions">
      <button class="btn primary" id="btnSave">Save day</button>
      <button class="btn" id="btnResetWork" style="white-space:nowrap">Reset this day</button>
    </div>
    <div class="version">Hour Logger 40</div>
  </section>

  <!-- Focus bubble -->
  <div id="focusLayer" class="focus-layer">
    <div class="backdrop" id="focusBackdrop"></div>
    <div class="bubble-date" id="bubbleDate">‚Äî</div>
    <div class="bubble" id="bubble"><canvas id="bubbleCanvas"></canvas><div id="bubbleHoliday" class="holiday-bubble">üèñÔ∏è</div></div>
    <div class="options" id="bubbleOptions">
      <button class="opt-btn" id="optEditLog">Edit logging</button>
      <button class="opt-btn" id="optFillMissing">Fill missing time</button>
      <button class="opt-btn" id="optResetDay">Reset this day</button>
    </div>
    <div class="details" id="bubbleDetails">
      <h4>Details</h4>
      <div class="row"><span>Breaks</span><strong id="dBreaks">‚Äî</strong></div>
      <div class="row"><span>Worked</span><strong id="dWorked">0h 00m</strong></div>
      <div class="row"><span>Comp used</span><strong id="dCompUsed">0h 00m</strong></div>
      <div class="row"><span>Overtime</span><strong id="dOver">0h 00m</strong></div>
    </div>
  </div>

  <!-- Update banner -->
  <div id="updateBanner" class="update-banner">
    <span>New version available ‚Äî Refresh</span>
    <button id="btnRefresh" class="btn small primary">Refresh</button>
  </div>

  <script>
    const APP_VERSION = "40";

    // Toast
    const __toast = document.getElementById('toast');
    function toast(msg){
      if(!__toast) return;
      __toast.textContent = msg;
      __toast.classList.add('show');
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=>__toast.classList.remove('show'), 1500);
    }
    // Theme
    const menuBtn = document.getElementById('btnMenu'), menuDD = document.getElementById('menuDD'), backBtn = document.getElementById('btnBack');
    const mLight = document.getElementById('mLight'), mDark = document.getElementById('mDark');
    const setTheme = t => { document.documentElement.setAttribute('data-theme', t); localStorage.setItem('hourlogger.theme', t); };
    setTheme(localStorage.getItem('hourlogger.theme') || 'dark');
    menuBtn.addEventListener('click', ()=> menuDD.classList.toggle('show'));
    mLight.addEventListener('click', ()=>{ setTheme('light'); menuDD.classList.remove('show'); });
    mDark .addEventListener('click', ()=>{ setTheme('dark');  menuDD.classList.remove('show'); });

    // Constants & state
    const TARGET=504, KEY='hourlogger.40';
    const state=JSON.parse(localStorage.getItem(KEY)||'{}'); state.work ||= {}; state.comp ||= {};
    const save=()=>localStorage.setItem(KEY, JSON.stringify(state));
    const pad=n=>String(n).padStart(2,'0');
    const toDateStr=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const startOfWeekMon=d=>{const x=new Date(d);const wd=(x.getDay()+6)%7;x.setDate(x.getDate()-wd);x.setHours(0,0,0,0);return x};
    const addDays=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x};
    const monthNames=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const dows=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    const fmtHM=m=>`${Math.floor(Math.abs(m)/60)}h ${String(Math.abs(m)%60).padStart(2,'0')}m`;
    const fmtSignedHM=m=>(m<0?'-':'')+fmtHM(m);
    const workMins=ds=>state.work[ds]?.netMins||0;
    const compMins=ds=>state.comp[ds]?.mins||0;
    const isHoliday=ds=>!!state.work[ds]?.holiday;
    const dayBankDelta=ds=>{ if(isHoliday(ds)) return 0; const w=workMins(ds), c=compMins(ds); return Math.max(0, w - TARGET) - c; };
    const overtimeBank=()=>{ const dates=new Set([...Object.keys(state.work),...Object.keys(state.comp)]); let t=0; dates.forEach(ds=>t+=dayBankDelta(ds)); return t; };

    // Background FX (RGB glow particles)
    const fx=document.getElementById('fxCanvas'),ctxFX=fx.getContext('2d'); let DPR=Math.max(1,Math.min(2,window.devicePixelRatio||1)),W=0,H=0,particles=[];
    function resizeFX(){W=fx.width=Math.floor(innerWidth*DPR);H=fx.height=Math.floor(innerHeight*DPR);fx.style.width=innerWidth+'px';fx.style.height=innerHeight+'px';}
    function rnd(a,b){return a+Math.random()*(b-a)}
    function initParticles(){ const count=12; particles=Array.from({length:count},()=>({x:rnd(0,W),y:rnd(0,H),r:rnd(70,140)*DPR,a:rnd(0,Math.PI*2),s:rnd(0.1,0.35),h:rnd(0,360)})); }
    function drawFX(){ ctxFX.clearRect(0,0,W,H); ctxFX.globalCompositeOperation='lighter'; for(const p of particles){ p.a+=0.002*p.s; p.x+=Math.cos(p.a)*0.25*DPR; p.y+=Math.sin(p.a)*0.25*DPR; p.h=(p.h+0.06)%360; const g=ctxFX.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r); g.addColorStop(0,`hsla(${p.h},90%,60%,.16)`); g.addColorStop(1,`hsla(${(p.h+60)%360},90%,50%,0)`); ctxFX.fillStyle=g; ctxFX.beginPath(); ctxFX.arc(p.x,p.y,p.r,0,Math.PI*2); ctxFX.fill(); } requestAnimationFrame(drawFX); }
    addEventListener('resize',()=>{resizeFX();initParticles();}); resizeFX(); initParticles(); drawFX();

    // Sand + water renderer (cracks removed)
    function SandWater(canvas, worked, compUsed, overtime){
      const ctx = canvas.getContext('2d');
      let raf=0, t=0, DPR=1, w=0, h=0;
      const bubblesBottom=[], bubblesTop=[];

      function size(){
        DPR = Math.max(1, Math.min(2, window.devicePixelRatio||1));
        const cw = Math.max(1, canvas.clientWidth|0);
        const ch = Math.max(1, canvas.clientHeight|0);
        w = canvas.width  = Math.floor(cw * DPR);
        h = canvas.height = Math.floor(ch * DPR);
      }
      function spawn(arr, area, count){ for(let i=0;i<count;i++){ arr.push({ x: area.x + Math.random()*area.w, y: area.y + area.h + Math.random()*10, r: 1 + Math.random()*2, vy: -(0.15+Math.random()*0.35)*DPR, drift:(Math.random()*0.4-0.2)*DPR }); } }
      function noise(y){ return (Math.sin(y*0.07 + t*0.8) + Math.sin(y*0.03 + t*0.6 + 2))/2; }

      function draw(){
        t += 0.016;
        ctx.clearRect(0,0,w,h);
        const half = h*0.5;

        const sandH = Math.min(half, half * (worked / 504));
        const compH = Math.min(Math.max(0, half - sandH), half * (compUsed / 504));
        const overH = Math.min(half, half * (Math.max(0,overtime) / 504));

        if (sandH>0){
          const topY = h - sandH;
          const grd = ctx.createLinearGradient(0, topY, 0, h); grd.addColorStop(0,'#daca9b'); grd.addColorStop(1,'#b8965b');
          ctx.fillStyle = grd; ctx.fillRect(0, topY, w, h-topY);
          for(let i=0;i<Math.floor(w*h*0.00035);i++){ const nx=Math.random()*w, ny=topY+Math.random()*(h-topY); ctx.fillStyle=`rgba(120,100,60,${Math.random()*0.35})`; ctx.fillRect(nx,ny,1,1);}
          for(let i=0;i<Math.floor(w*h*0.00005);i++){ const nx=Math.random()*w, ny=topY+Math.random()*(h-topY); ctx.fillStyle='rgba(90,70,30,0.25)'; ctx.beginPath(); ctx.arc(nx,ny,Math.random()*1.6+0.4,0,Math.PI*2); ctx.fill(); }
          ctx.beginPath(); ctx.moveTo(0, topY);
          for(let x=0;x<=w;x+=3){ const y=topY - 3*DPR + noise(x)*3*DPR; ctx.lineTo(x,y); } ctx.lineTo(w, topY); ctx.closePath(); ctx.fillStyle='rgba(255,255,255,0.06)'; ctx.fill();
        }

        if (compH>0){
          const area={x:0,y:h - sandH - compH,w:w,h:compH}; const waveY=area.y + 6*DPR + Math.sin(t*1.8)*2*DPR;
          const grdW=ctx.createLinearGradient(0,area.y,0,area.y+area.h); grdW.addColorStop(0,'rgba(100,180,255,0.55)'); grdW.addColorStop(1,'rgba(30,90,180,0.7)');
          ctx.fillStyle=grdW; ctx.fillRect(area.x,area.y,area.w,area.h);
          if(bubblesBottom.length<28) spawn(bubblesBottom, area, 2);
          for(let i=bubblesBottom.length-1;i>=0;i--){ const b=bubblesBottom[i]; b.y+=b.vy; b.x+=Math.sin((t+i)*0.8)*0.2*DPR+b.drift; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fillStyle='rgba(255,255,255,0.5)'; ctx.fill(); if(b.y<area.y+4*DPR) bubblesBottom.splice(i,1); }
          ctx.beginPath(); ctx.moveTo(0,waveY); for(let x=0;x<=w;x+=4){ const y=waveY + Math.sin(x*0.04 + t*2.2)*2*DPR + Math.sin(x*0.025 + t*1.7)*1.2*DPR; ctx.lineTo(x,y);} ctx.lineTo(w,area.y); ctx.lineTo(0,area.y); ctx.closePath(); ctx.fillStyle='rgba(255,255,255,0.08)'; ctx.fill();
        }

        if (overH>0){
          const area={x:0,y:half - overH,w:w,h:overH}; const waveY=area.y + 6*DPR + Math.sin(t*2.0)*2*DPR;
          const grdW2=ctx.createLinearGradient(0,area.y,0,area.y+area.h); grdW2.addColorStop(0,'rgba(120,200,255,0.55)'); grdW2.addColorStop(1,'rgba(10,70,160,0.75)');
          ctx.fillStyle=grdW2; ctx.fillRect(area.x,area.y,area.w,area.h);
          if(bubblesTop.length<20) spawn(bubblesTop, area, 1);
          for(let i=bubblesTop.length-1;i>=0;i--){ const b=bubblesTop[i]; b.y+=b.vy; b.x+=Math.sin((t+i)*1.1)*0.25*DPR+b.drift; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fillStyle='rgba(255,255,255,0.5)'; ctx.fill(); if(b.y<area.y+2*DPR) bubblesTop.splice(i,1); }
          ctx.beginPath(); ctx.moveTo(0,waveY); for(let x=0;x<=w;x+=4){ const y=waveY + Math.sin(x*0.05 + t*2.0)*2*DPR + Math.sin(x*0.03 + t*1.6)*1.2*DPR; ctx.lineTo(x,y);} ctx.lineTo(w,area.y); ctx.lineTo(0,area.y); ctx.closePath(); ctx.fillStyle='rgba(255,255,255,0.08)'; ctx.fill();
        }

        // midline
        const ctxLine = ctx; ctxLine.strokeStyle='rgba(255,255,255,0.06)'; ctxLine.lineWidth=1*DPR; ctxLine.beginPath(); ctxLine.moveTo(0,h*0.5); ctxLine.lineTo(w,h*0.5); ctxLine.stroke();

        raf = requestAnimationFrame(draw);
      }
      function start(){ cancel(); size(); raf = requestAnimationFrame(draw); }
      function cancel(){ if(raf) cancelAnimationFrame(raf); raf=0; }
      const ro = new ResizeObserver(()=>start()); ro.observe(canvas);
      requestAnimationFrame(start);
      return { cancel, start };
    }

    // Views
    const views={menu:document.getElementById('view-menu'),calendar:document.getElementById('view-calendar'),logger:document.getElementById('view-logger')};
    function show(n){for(const v in views) views[v].classList.remove('active'); views[n].classList.add('active'); backBtn.style.visibility = (n==='menu') ? 'hidden' : 'visible'; if(n==='menu') renderMenu(); if(n==='calendar') renderWeek(); if(n==='logger') renderLogger();}
    document.getElementById('goCalendar').addEventListener('click',()=>show('calendar'));
    document.getElementById('goLogger').addEventListener('click',()=>show('logger'));
    backBtn.addEventListener('click', ()=> show('menu'));

    function renderMenu(){ const ws=startOfWeekMon(new Date()); let sum=0; for(let i=0;i<7;i++){ sum+=workMins(toDateStr(addDays(ws,i))); } document.getElementById('pillWeek').textContent='Weekly hours: '+fmtHM(sum); document.getElementById('pillBank').textContent='Overtime bank: '+fmtSignedHM(overtimeBank()); }

    // Calendar
    const weekTitle=document.getElementById('wTitle'), weekStrip=document.getElementById('weekStrip'), calFooter=document.getElementById('calFooter'); let weekStart=startOfWeekMon(new Date());
    const dayControllers = new Map();

    function renderWeek(){
      const ws=new Date(weekStart), we=addDays(ws,6);
      weekTitle.textContent = `${ws.getDate()} ${monthNames[ws.getMonth()]} ‚Äì ${we.getDate()} ${monthNames[we.getMonth()]} ${we.getFullYear()}`;
      for (const ctrl of dayControllers.values()) ctrl.cancel?.();
      dayControllers.clear();
      weekStrip.innerHTML = '';
      let weekSum = 0;

      for (let i=0;i<7;i++){
        const d = addDays(ws,i);
        const ds = toDateStr(d);
        const worked = workMins(ds);
        const compUsed = compMins(ds);
        const overtime = Math.max(0, worked - TARGET);
        weekSum += worked;

        const wrap = document.createElement('div'); wrap.className='day-wrap';
        const el = document.createElement('div'); el.className='day'; if (ds===toDateStr(new Date())) el.classList.add('today');
        el.innerHTML = `<span class="n">${dows[(d.getDay()+6)%7]} ${d.getDate()}</span><span class="pct">${Math.round(Math.min(1,(worked+compUsed)/TARGET)*100)}%</span><span class="h">${worked?fmtHM(worked):''}</span>`;
        if(isHoliday(ds)){ const hv=document.createElement('div'); hv.className='holiday'; hv.textContent='üèñÔ∏è'; el.appendChild(hv); }
        const canvas = document.createElement('canvas'); el.appendChild(canvas);
        requestAnimationFrame(()=>{
          const ctrl = SandWater(canvas, Math.min(worked, TARGET), compUsed, overtime);
          dayControllers.set(el, ctrl);
        });
        el.addEventListener('click', ()=> openBubbleCentered(ds, worked, compUsed, overtime));

        const fb = document.createElement('button'); fb.className='fill-btn'; fb.textContent = 'Fill missing time';
        if (compUsed>0 && (worked+compUsed)>=TARGET) fb.classList.add('active');
        fb.addEventListener('click', (ev)=>{
          ev.stopPropagation();
          const need = Math.max(0, TARGET - workMins(ds));
          const current = compMins(ds);
          const next = (current === need) ? 0 : need;
          if(next>0){ state.comp[ds] = { mins: next, note: 'auto-fill' }; } else { delete state.comp[ds]; }
          save(); renderMenu(); renderWeek(); toast(next>0 ? 'Filled missing time' : 'Compensation cleared');
        });

        wrap.appendChild(el); wrap.appendChild(fb);
        weekStrip.appendChild(wrap);
      }

      calFooter.innerHTML = `<strong>Weekly hours:</strong> ${fmtHM(weekSum)} ¬∑ <strong>Overtime bank:</strong> ${fmtSignedHM(overtimeBank())}`;
    }

    // Logger
    function nowHHMM(){ const n=new Date(); return `${pad(n.getHours())}:${pad(n.getMinutes())}`; }
    function parseHHMM(t){ const [h,m]=t.split(':').map(Number); return h*60+m; }
    function validTime(t){ return /^\\d{2}:\\d{2}$/.test(t); }
    const breaksPane=document.getElementById('breaksPane');
    function computeTotal(){ const a=document.getElementById('startTime').value.trim(), b=document.getElementById('stopTime').value.trim(); if(!validTime(a)||!validTime(b)){ var __ct=document.getElementById('computedTotal'); if(__ct){ __ct.textContent='0h 00m'; } return 0; }
      let work=parseHHMM(b)-parseHHMM(a); if(work<0) work+=24*60; let bt=0; breaksPane.querySelectorAll('.break-item').forEach(it=>{ const s=it.querySelector('.bi-start').value.trim(), e=it.querySelector('.bi-stop').value.trim(); if(validTime(s)&&validTime(e)){ let m=parseHHMM(e)-parseHHMM(s); if(m>0) bt+=m; }});
      const net=Math.max(0,work-bt); if (document.getElementById('computedTotal')) var __ct2=document.getElementById('computedTotal'); if(__ct2){ __ct2.textContent=fmtHM(net); } return net; }
    function addBreakRow(i={name:'',start:'',stop:''}){
      const row=document.createElement('div'); row.className='break-item';
      row.innerHTML = `
        <div class="bi-name-block">
          <label>Name</label>
          <input type="text" class="bi-name" value="${i.name||''}" placeholder="Name">
        </div>
        <div class="bi-times">
          <div><label>Start</label><input type="time" class="bi-start" value="${i.start||''}"></div>
          <div><label>Stop</label><input type="time" class="bi-stop" value="${i.stop||''}"></div>
        </div>
        <div><button class="btn small bi-remove">Remove break</button></div>`;
      breaksPane.appendChild(row);
      const onChange=()=>computeTotal();
      row.querySelectorAll('input').forEach(inp=>inp.addEventListener('input',onChange));
      row.querySelector('.bi-remove').addEventListener('click',()=>{ row.remove(); computeTotal(); }); computeTotal(); }
    function clearLoggerFor(ds){ document.getElementById('startTime').value=''; document.getElementById('stopTime').value=''; breaksPane.innerHTML=''; var __ct=document.getElementById('computedTotal'); if(__ct){ __ct.textContent='0h 00m'; } const w=state.work[ds]; document.getElementById('holidayFlag').checked=!!(w&&w.holiday);
      if(w){ document.getElementById('startTime').value=w.start||''; document.getElementById('stopTime').value=w.stop||''; (w.breaks||[]).forEach(b=>addBreakRow(b)); computeTotal(); } }
    function renderLogger(){ const input=document.getElementById('logDate'); if(!input.value) input.value=toDateStr(new Date()); clearLoggerFor(input.value); }
    document.getElementById('logDate').addEventListener('change',e=>clearLoggerFor(e.target.value));
    document.getElementById('btnStartNow').addEventListener('click',()=>{document.getElementById('startTime').value=nowHHMM(); computeTotal();});
    document.getElementById('btnStopNow').addEventListener('click',()=>{document.getElementById('stopTime').value=nowHHMM(); computeTotal();});
    document.getElementById('btnAddBreak').addEventListener('click',()=>addBreakRow());
    document.getElementById('startTime').addEventListener('input',computeTotal); document.getElementById('stopTime').addEventListener('input',computeTotal);
    document.getElementById('btnSave').addEventListener('click',()=>{ const ds=document.getElementById('logDate').value||toDateStr(new Date()); const a=document.getElementById('startTime').value.trim(), b=document.getElementById('stopTime').value.trim(); if(!/^\d{2}:\d{2}$/.test(a)||!/^\d{2}:\d{2}$/.test(b)){ /* allow empty save */ }
      const net=computeTotal(); const breaks=[]; document.querySelectorAll('#breaksPane .break-item').forEach(it=>breaks.push({name:it.querySelector('.bi-name').value.trim(),start:it.querySelector('.bi-start').value.trim(),stop:it.querySelector('.bi-stop').value.trim()}));
      const holiday=document.getElementById('holidayFlag').checked; state.work[ds]={start:a,stop:b,breaks,netMins:net,holiday}; save(); renderMenu(); renderWeek(); toast('Day saved'); show('calendar'); });
    document.getElementById('btnResetWork').addEventListener('click',()=>{ const ds=document.getElementById('logDate').value||toDateStr(new Date()); if(state.work[ds]) delete state.work[ds]; if(state.comp[ds]) delete state.comp[ds]; save(); clearLoggerFor(ds); renderMenu(); renderWeek(); toast('Day reset'); });

    // Bubble
    const focusLayer=document.getElementById('focusLayer'), bubble=document.getElementById('bubble'), bubbleCanvas=document.getElementById('bubbleCanvas'), bubbleOptions=document.getElementById('bubbleOptions'), bubbleDateLbl=document.getElementById('bubbleDate'), bubbleDetails=document.getElementById('bubbleDetails');
    let bubbleCtrl=null, bubbleDate=null;
    function openBubbleCentered(ds, worked, compUsed, overtime){
      bubbleDate = ds;
      bubbleDateLbl.textContent = ds;
      const vw = window.innerWidth, vh = window.innerHeight;
const bw = Math.min(360, vw - 32), bh = 200;
bubble.style.width = bw + 'px'; bubble.style.height = bh + 'px';
function positionBubbleLayout(){
  const topSafe = Math.max(70, (innerWidth<420?60:80));
  bubble.style.left = (vw/2 - bw/2) + 'px';
  bubble.style.top  = topSafe + 'px';
  bubbleOptions.style.left = '16px'; bubbleOptions.style.right = '16px';
  bubbleOptions.style.top = (topSafe + bh + 12) + 'px';
  const optRect = bubbleOptions.getBoundingClientRect();
  bubbleDetails.style.top = (parseFloat(bubbleOptions.style.top) + (optRect.height||110) + 24) + 'px';
}
positionBubbleLayout();
requestAnimationFrame(positionBubbleLayout);
setTimeout(positionBubbleLayout, 100);
window.addEventListener('resize', positionBubbleLayout, { once: true });

      const wObj = state.work[ds]||{};
      document.getElementById('dBreaks').textContent= (wObj.breaks||[]).map(b=>`${b.name||'Break'} ${b.start}-${b.stop}`).join(', ') || '‚Äî';
      document.getElementById('dWorked').textContent= fmtHM(worked);
      document.getElementById('dCompUsed').textContent= fmtHM(compUsed);
      document.getElementById('dOver').textContent  = fmtHM(Math.max(0,overtime));

      const bhEl = document.getElementById('bubbleHoliday'); if (bhEl) bhEl.classList.toggle('show', !!isHoliday(ds));
      focusLayer.classList.add('active');
      if(navigator.vibrate){ navigator.vibrate(10); }

      if(bubbleCtrl) bubbleCtrl.cancel();
      requestAnimationFrame(()=>{
        bubbleCtrl = SandWater(bubbleCanvas, Math.min(worked,504), compUsed, Math.max(0,overtime));
      });
    }
    document.getElementById('focusBackdrop').addEventListener('click',()=>{ focusLayer.classList.remove('active'); if(bubbleCtrl) bubbleCtrl.cancel(); });
    document.getElementById('optEditLog').addEventListener('click',()=>{ if(bubbleDate){ document.getElementById('logDate').value=bubbleDate; renderLogger(); focusLayer.classList.remove('active'); if(bubbleCtrl) bubbleCtrl.cancel(); show('logger'); } });
    document.getElementById('optFillMissing').addEventListener('click',()=>{
      if(!bubbleDate) return;
      const ds=bubbleDate;
      const need = Math.max(0, 504 - workMins(ds));
      const current = compMins(ds);
      const next = (current === need) ? 0 : need;
      if(next>0){ state.comp[ds] = { mins: next, note: 'auto-fill' }; } else { delete state.comp[ds]; }
      save(); renderMenu(); renderWeek(); toast(next>0 ? 'Filled missing time' : 'Compensation cleared');
      const worked = workMins(ds), compUsed = compMins(ds), overtime = Math.max(0, worked-504);
      if(bubbleCtrl) bubbleCtrl.cancel();
      requestAnimationFrame(()=>{
        bubbleCtrl = SandWater(bubbleCanvas, Math.min(worked,504), compUsed, Math.max(0,overtime));
      });
      document.getElementById('dCompUsed').textContent=fmtHM(compUsed); toast(next>0 ? 'Filled missing time' : 'Compensation cleared');
    });
    document.getElementById('optResetDay').addEventListener('click',()=>{
      if(!bubbleDate) return;
      const ds=bubbleDate; if(state.work[ds]) delete state.work[ds]; if(state.comp[ds]) delete state.comp[ds]; save(); renderMenu(); renderWeek(); focusLayer.classList.remove('active'); if(bubbleCtrl) bubbleCtrl.cancel();
    });

    // Service worker with "New version available ‚Äî Refresh"
    const updateBanner = document.getElementById('updateBanner');
    const btnRefresh = document.getElementById('btnRefresh');
    if('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js').then(reg=>{
        function listenForWaiting(swReg){
          if(swReg.waiting){ updateBanner.classList.add('show'); }
          swReg.addEventListener('updatefound',()=>{
            const newWorker = swReg.installing;
            if(newWorker) newWorker.addEventListener('statechange',()=>{
              if(newWorker.state==='installed' && navigator.serviceWorker.controller){ updateBanner.classList.add('show'); }
            });
          });
        }
        listenForWaiting(reg);
        btnRefresh.addEventListener('click',()=>{
          if(reg.waiting){ reg.waiting.postMessage({type:'SKIP_WAITING'}); }
          updateBanner.classList.remove('show');
          setTimeout(()=>location.reload(), 150);
        });
      });
      navigator.serviceWorker.addEventListener('controllerchange', ()=>{ /* page will reload */ });
    }
  
    // ---- SAFE REBIND ----
    /* SAFE REBIND */ 
    (function(){
      function byId(id){ return document.getElementById(id); }
      function validTime(t){ return /^\d{2}:\d{2}$/.test(t); }
      function parseHHMM(t){ const [h,m]=t.split(':').map(Number); return h*60+m; }
      function fmt(m){ return (Math.floor(m/60))+'h '+String(m%60).padStart(2,'0')+'m'; }
      function computeNet(){
        const a=byId('startTime').value.trim(), b=byId('stopTime').value.trim();
        if(!validTime(a)||!validTime(b)) return 0;
        let w=parseHHMM(b)-parseHHMM(a); if(w<0) w+=24*60;
        let bt=0; document.querySelectorAll('#breaksPane .break-item').forEach(it=>{
          const s=it.querySelector('.bi-start')?.value.trim()||'', e=it.querySelector('.bi-stop')?.value.trim()||'';
          if(validTime(s)&&validTime(e)){ let m=parseHHMM(e)-parseHHMM(s); if(m>0) bt+=m; }
        });
        return Math.max(0,w-bt);
      }
      function saveDay(){
        try{
          const a=byId('startTime').value.trim(), b=byId('stopTime').value.trim();
          /* allow empty save even without start/stop */
          const ds = byId('logDate').value || (new Date()).toISOString().slice(0,10);
          const net = (validTime(a) && validTime(b)) ? computeNet() : 0;
          const breaks=[]; document.querySelectorAll('#breaksPane .break-item').forEach(it=>breaks.push({
            name: it.querySelector('.bi-name')?.value.trim()||'',
            start: it.querySelector('.bi-start')?.value.trim()||'',
            stop: it.querySelector('.bi-stop')?.value.trim()||''
          }));
          const holiday = byId('holidayFlag').checked;
          try { state.work ||= {}; } catch(e){ window.state = window.state || {}; state.work = state.work || {}; }
          state.work[ds] = { start:a, stop:b, breaks, netMins: net, holiday };
          save();
          if (typeof renderMenu==='function') renderMenu();
          if (typeof renderWeek==='function') renderWeek();
          if (typeof toast==='function') toast('Day saved'); if (typeof show==='function') show('calendar');
        } catch (e){
          console.error('Save failed', e);
          alert('Save failed. Please try again.');
        }
      }
      const btn = byId('btnSave');
      if(btn){ btn.addEventListener('click', saveDay); }
    })();
    
  </script>
</body>
</html>
