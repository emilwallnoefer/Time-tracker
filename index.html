<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Hour Logger</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    :root { --pad:16px; --bg:#0b0c0f; --card:#111319; --muted:#9aa3b2; --text:#e8ebf0; --stroke:#1c2030; --pill:#151823; --glow:0 0 32px rgba(91,140,255,.08); }
    [data-theme="light"] { --bg:#f7f7fb; --card:#ffffff; --muted:#667084; --text:#101828; --stroke:#e5e7eb; --pill:#eef1f5; --glow:0 0 0 rgba(0,0,0,0); }
    [data-theme="dark"]  { --bg:#0b0c0f; --card:#111319; --muted:#9aa3b2; --text:#e8ebf0; --stroke:#1c2030; --pill:#151823; --glow:0 0 32px rgba(91,140,255,.08); }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);position:relative}
    #fxCanvas{position:fixed;inset:0;z-index:0;pointer-events:none;filter:blur(10px)}
    .fx-top{position:relative;z-index:1}

    .topbar{position:sticky;top:0;display:flex;gap:10px;align-items:center;padding:10px var(--pad);background:#0f1118aa;border-bottom:1px solid var(--stroke);backdrop-filter:saturate(180%) blur(8px);z-index:10}
    .title{font-weight:800; font-size:18px; text-align:center; flex:1}
    .btn{border:1px solid var(--stroke);background:#181b24;color:var(--text);border-radius:12px;padding:10px 14px;box-shadow:var(--glow)}
    .icon-btn{border:1px solid var(--stroke);background:#181b24;border-radius:12px;padding:10px;display:grid;place-items:center; width:40px; height:40px}

    .menu-dd{ position:absolute; top:56px; right:10px; background:var(--card); border:1px solid var(--stroke); border-radius:12px; padding:8px; display:none; box-shadow:0 24px 80px #0006 }
    .menu-dd.show{ display:block; }
    .menu-dd button{ display:block; width:100%; margin:4px 0; }

    .view{display:none;padding:12px var(--pad);position:relative;z-index:1}
    .view.active{display:block;animation:fade .3s ease both}
    @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

    .hero{min-height:110px;border:1px solid var(--stroke);border-radius:22px;display:grid;place-items:center;background:radial-gradient(120% 120% at 10% 0%,rgba(91,140,255,.14),transparent 60%),radial-gradient(120% 120% at 90% 100%,rgba(192,132,252,.16),transparent 60%),var(--card);box-shadow:var(--glow)}
    .cards{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:16px;padding:14px;display:flex;gap:12px;align-items:center;box-shadow:var(--glow)}
    .card h3{margin:0;font-size:16px}
    .card p{margin:4px 0 0;color:var(--muted);font-size:13px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border:1px solid var(--stroke);border-radius:999px;font-size:12px;color:var(--muted);background:var(--pill);box-shadow:var(--glow)}

    .week-card{ background:var(--card); border:1px solid var(--stroke); border-radius:16px; padding:12px; box-shadow:var(--glow); }
    .week-head{ display:grid; grid-template-columns: 1fr auto; align-items:center; gap:8px; }
    .week-title{ font-weight:800; font-size:22px; }
    .week-nav{ display:flex; gap:8px; }
    .week-strip{display:grid;grid-auto-flow:column;grid-auto-columns:minmax(140px,1fr);gap:12px;overflow-x:auto;scroll-snap-type:x mandatory;padding:10px 2px 10px}
    .day-wrap{display:grid;grid-template-rows:auto auto;gap:6px}
    .fill-btn{border:1px dashed var(--stroke);background:transparent;color:var(--muted);border-radius:12px;padding:8px 10px;font-size:12px}
    .fill-btn.active{border-style:solid;color:var(--text);}
    .day{position:relative;background:var(--card);border:1px solid var(--stroke);border-radius:18px;min-height:160px;overflow:hidden;scroll-snap-align:start;box-shadow:var(--glow)}
    .day.today{outline:2px solid #5b8cff;outline-offset:-2px}
    .day .n{position:absolute;top:10px;left:12px;font-size:12px;font-weight:700;z-index:2;text-shadow:0 2px 6px #0008}
    .day .h{position:absolute;bottom:10px;right:12px;font-weight:700;font-size:12px;z-index:2;text-shadow:0 2px 6px #0008}
    .day .pct{position:absolute;bottom:10px;left:12px;font-weight:700;font-size:12px;z-index:2;opacity:.9;text-shadow:0 2px 6px #0008}
    .day canvas{ position:absolute; inset:0; width:100%; height:100%; z-index:1; pointer-events:none }

    .cal-footer{display:flex;gap:10px;flex-wrap:wrap;padding-top:10px;border-top:1px solid var(--stroke);margin-top:8px}

    /* Focus + bubble */
    .focus-layer{position:fixed;inset:0;display:none;z-index:50}
    .focus-layer.active{display:block}
    .backdrop{position:absolute;inset:0;background:#0006;backdrop-filter:blur(10px) saturate(120%)}
    .bubble-date{ position: fixed; top: calc(env(safe-area-inset-top, 0px) + 10px); left: 0; right: 0; text-align:center; font-weight:800; z-index:52 }
    .bubble{position:fixed;border-radius:18px;background:radial-gradient(120% 140% at 20% 10%,rgba(255,255,255,.08),transparent 60%),var(--card);border:1px solid var(--stroke);box-shadow:0 40px 120px #0006,0 0 80px rgba(91,140,255,.15);overflow:hidden;animation:gel .7s cubic-bezier(.2,.8,.2,1) both; z-index:52 }
    @keyframes gel{0%{filter:saturate(.9) blur(.35px)}40%{filter:saturate(1.05) blur(.2px)}100%{filter:saturate(1) blur(0)}}
    .bubble canvas{ position:absolute; inset:0; width:100%; height:100%; }
    .options{position:fixed; display:grid; gap:8px; padding:10px 16px; left: 0; right: 0; z-index:53 }
    .opt-btn{border:1px solid var(--stroke);background:#141824;color:var(--text);border-radius:14px;padding:12px 14px;box-shadow:var(--glow);opacity:0;transform:translateY(8px);animation:pop .5s ease forwards}
    .opt-btn:nth-child(1){animation-delay:.12s}.opt-btn:nth-child(2){animation-delay:.2s}.opt-btn:nth-child(3){animation-delay:.28s}
    @keyframes pop{to{opacity:1;transform:none}}
    .details{ position:fixed; left:16px; right:16px; background:var(--card); border:1px solid var(--stroke); border-radius:14px; padding:12px; box-shadow:var(--glow); z-index:53 }
    .details h4{ margin:0 0 6px 0; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; justify-content:space-between; }
  </style>
</head>
<body>
  <canvas id="fxCanvas"></canvas>

  <div class="topbar fx-top">
    <button class="icon-btn" id="btnBack" aria-label="Back">◀︎</button>
    <div class="title">Hour Logger</div>
    <button class="icon-btn" id="btnMenu" aria-label="Menu">☰</button>
    <div class="menu-dd" id="menuDD">
      <button class="btn" id="mLight">Light</button>
      <button class="btn" id="mDark">Dark</button>
    </div>
  </div>

  <!-- MENU -->
  <section id="view-menu" class="view active fx-top">
    <div class="hero"><h1>Track your day</h1></div>
    <div class="cards">
      <div class="pill" id="pillWeek">Weekly hours: 0h 00m</div>
      <div class="pill" id="pillBank">Overtime bank: 0h 00m</div>
      <div class="card">
        <div><h3>Today’s logging</h3><p>Working time (-breaks), start/stop, breaks, save.</p></div>
        <button class="btn" id="goLogger">Open</button>
      </div>
      <div class="card">
        <div><h3>Calendar (weekly)</h3><p>Tap a day, bubble shows actions.</p></div>
        <button class="btn" id="goCalendar">Open</button>
      </div>
    </div>
  </section>

  <!-- CALENDAR -->
  <section id="view-calendar" class="view fx-top">
    <div class="week-card">
      <div class="week-head">
        <div class="week-title" id="wTitle">—</div>
        <div class="week-nav">
          <button class="btn" id="wPrev">◀︎</button>
          <button class="btn" id="wToday">Today</button>
          <button class="btn" id="wNext">▶︎</button>
        </div>
      </div>
      <div id="weekStrip" class="week-strip"></div>
      <div class="cal-footer" id="calFooter"></div>
    </div>
  </section>

  <!-- LOGGER -->
  <section id="view-logger" class="view fx-top">
    <div class="card">
      <label>Date</label>
      <input type="date" id="logDate" />
      <div style="margin-top:8px">
        <label style="display:flex;align-items:center;gap:8px;">
          <input type="checkbox" id="holidayFlag" />
          <span>Public holiday (full day)</span>
        </label>
      </div>
    </div>
    <div class="card">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div><label><b>Start</b></label><input type="time" id="startTime"/><button class="btn" id="btnStartNow" style="margin-top:8px;width:100%">Start now</button></div>
        <div><label><b>Stop</b></label><input type="time" id="stopTime"/><button class="btn" id="btnStopNow" style="margin-top:8px;width:100%">Stop now</button></div>
        <div style="grid-column:1/-1;display:grid;place-items:center;gap:8px">
          <button class="btn" id="btnAddBreak">+ Add break</button>
          <div id="breaksPane" style="width:100%;max-height:200px;overflow:auto"></div>
        </div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
        <span class="pill">Working time (-breaks)</span><strong id="computedTotal">0h 00m</strong>
      </div>
    </div>
    <div class="card">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="btnSave">Save day</button>
        <button class="btn" id="btnResetWork">Reset this day</button>
      </div>
    </div>
  </section>

  <!-- Focus bubble -->
  <div id="focusLayer" class="focus-layer">
    <div class="backdrop" id="focusBackdrop"></div>
    <div class="bubble-date" id="bubbleDate">—</div>
    <div class="bubble" id="bubble"><canvas id="bubbleCanvas"></canvas></div>
    <div class="options" id="bubbleOptions">
      <button class="opt-btn" id="optEditLog">Edit logging</button>
      <button class="opt-btn" id="optFillMissing">Fill missing time</button>
      <button class="opt-btn" id="optResetDay">Reset this day</button>
    </div>
    <div class="details" id="bubbleDetails">
      <h4>Details</h4>
      <div class="row"><span>Breaks</span><strong id="dBreaks">—</strong></div>
      <div class="row"><span>Worked</span><strong id="dWorked">0h 00m</strong></div>
      <div class="row"><span>Comp used</span><strong id="dCompUsed">0h 00m</strong></div>
      <div class="row"><span>Overtime</span><strong id="dOver">0h 00m</strong></div>
    </div>
  </div>

  <script>
    const menuBtn = document.getElementById('btnMenu'), menuDD = document.getElementById('menuDD'), backBtn = document.getElementById('btnBack');
    const mLight = document.getElementById('mLight'), mDark = document.getElementById('mDark');
    const setTheme = t => { document.documentElement.setAttribute('data-theme', t); localStorage.setItem('hourlogger.theme', t); };
    setTheme(localStorage.getItem('hourlogger.theme') || 'dark');
    menuBtn.addEventListener('click', ()=> menuDD.classList.toggle('show'));
    mLight.addEventListener('click', ()=>{ setTheme('light'); menuDD.classList.remove('show'); });
    mDark .addEventListener('click', ()=>{ setTheme('dark');  menuDD.classList.remove('show'); });

    // Constants & state
    const TARGET=504, KEY='hourlogger.v22.5.1'; const state=JSON.parse(localStorage.getItem(KEY)||'{}'); state.work ||= {}; state.comp ||= {}; const save=()=>localStorage.setItem(KEY, JSON.stringify(state));
    const pad=n=>String(n).padStart(2,'0'); const toDateStr=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; const startOfWeekMon=d=>{const x=new Date(d);const wd=(x.getDay()+6)%7;x.setDate(x.getDate()-wd);x.setHours(0,0,0,0);return x}; const addDays=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x};
    const monthNames=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; const dows=['Mon','Tue','Wed','Thu','Fri','Sat','Sun']; const fmtHM=m=>`${Math.floor(Math.abs(m)/60)}h ${String(Math.abs(m)%60).padStart(2,'0')}m`; const fmtSignedHM=m=>(m<0?'-':'')+fmtHM(m);
    const workMins=ds=>state.work[ds]?.netMins||0; const compMins=ds=>state.comp[ds]?.mins||0; const isHoliday=ds=>!!state.work[ds]?.holiday;
    const dayBankDelta=ds=>{ if(isHoliday(ds)) return 0; const w=workMins(ds), c=compMins(ds); return Math.max(0, w - TARGET) - c; };
    const overtimeBank=()=>{ const dates=new Set([...Object.keys(state.work),...Object.keys(state.comp)]); let t=0; dates.forEach(ds=>t+=dayBankDelta(ds)); return t; };

    // Background FX
    const fx=document.getElementById('fxCanvas'),ctxFX=fx.getContext('2d'); let DPR=Math.max(1,Math.min(2,window.devicePixelRatio||1)),W=0,H=0,particles=[];
    function resizeFX(){W=fx.width=Math.floor(innerWidth*DPR);H=fx.height=Math.floor(innerHeight*DPR);fx.style.width=innerWidth+'px';fx.style.height=innerHeight+'px';}
    function rnd(a,b){return a+Math.random()*(b-a)}
    function initParticles(){ const count=16; particles=Array.from({length:count},()=>({x:rnd(0,W),y:rnd(0,H),r:rnd(60,140)*DPR,a:rnd(0,Math.PI*2),s:rnd(0.1,0.35),h:rnd(0,360)})); }
    function drawFX(){ ctxFX.clearRect(0,0,W,H); ctxFX.globalCompositeOperation='lighter'; for(const p of particles){ p.a+=0.002*p.s; p.x+=Math.cos(p.a)*0.2*DPR; p.y+=Math.sin(p.a)*0.2*DPR; p.h=(p.h+0.05)%360; const g=ctxFX.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r); g.addColorStop(0,`hsla(${p.h},90%,60%,.18)`); g.addColorStop(1,`hsla(${(p.h+60)%360},90%,50%,0)`); ctxFX.fillStyle=g; ctxFX.beginPath(); ctxFX.arc(p.x,p.y,p.r,0,Math.PI*2); ctxFX.fill(); } requestAnimationFrame(drawFX); }
    addEventListener('resize',()=>{resizeFX();initParticles();}); resizeFX(); initParticles(); drawFX();

    // RNG
    function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296}}

    function SandWater(canvas, worked, compUsed, overtime, fullCrack){
      const ctx = canvas.getContext('2d');
      let raf=0, t=0, DPR=1, w=0, h=0;
      const bubblesBottom=[], bubblesTop=[];

      function size(){
        DPR = Math.max(1, Math.min(2, window.devicePixelRatio||1));
        const cw = Math.max(1, canvas.clientWidth|0);
        const ch = Math.max(1, canvas.clientHeight|0);
        w = canvas.width  = Math.floor(cw * DPR);
        h = canvas.height = Math.floor(ch * DPR);
      }
      function spawn(arr, area, count){
        for(let i=0;i<count;i++){
          arr.push({ x: area.x + Math.random()*area.w, y: area.y + area.h + Math.random()*10, r: 1 + Math.random()*2, vy: -(0.15+Math.random()*0.35)*DPR, drift:(Math.random()*0.4-0.2)*DPR });
        }
      }
      function noise(y){ return (Math.sin(y*0.07 + t*0.8) + Math.sin(y*0.03 + t*0.6 + 2))/2; }

      const crackSeed = Math.floor((worked+compUsed+overtime)*12345);
      const rand = mulberry32(crackSeed>>>0);
      const crackPaths = [];
      function computeCracks(){
        crackPaths.length = 0;
        const strength = fullCrack ? 1 : Math.min(1, Math.max(0, overtime / 504));
        if(strength<=0) return;
        const rays = 12 + Math.floor(12 * strength);
        const cx = w/2, cy = h/2;
        const len = Math.hypot(w,h);
        for(let i=0;i<rays;i++){
          const ang = (Math.PI*2)*(i/rays) + (rand()-0.5)*0.12;
          const pts = [[cx,cy]];
          for(let s=1;s<=6;s++){
            const p = s/6;
            const jx = cx + Math.cos(ang)*len*p + Math.sin(ang)*((rand()-0.5)*10)*DPR;
            const jy = cy + Math.sin(ang)*len*p + Math.cos(ang)*((rand()-0.5)*10)*DPR;
            pts.push([jx,jy]);
          }
          crackPaths.push(pts);
        }
      }

      function draw(){
        t += 0.016;
        ctx.clearRect(0,0,w,h);
        const half = h*0.5;
        const showSand = overtime<=0;
        const sandH = showSand ? Math.min(half, half * (worked / 504)) : 0;
        const compH = Math.min(half - sandH, half * (compUsed / 504));
        const overH = Math.min(half, half * (Math.max(0,overtime) / 504));

        if (showSand && sandH>0){
          const topY = h - sandH;
          const grd = ctx.createLinearGradient(0, topY, 0, h); grd.addColorStop(0,'#daca9b'); grd.addColorStop(1,'#b8965b');
          ctx.fillStyle = grd; ctx.fillRect(0, topY, w, h-topY);
          for(let i=0;i<Math.floor(w*h*0.00035);i++){ const nx=Math.random()*w, ny=topY+Math.random()*(h-topY); ctx.fillStyle=`rgba(120,100,60,${Math.random()*0.35})`; ctx.fillRect(nx,ny,1,1);}
          for(let i=0;i<Math.floor(w*h*0.00005);i++){ const nx=Math.random()*w, ny=topY+Math.random()*(h-topY); ctx.fillStyle='rgba(90,70,30,0.25)'; ctx.beginPath(); ctx.arc(nx,ny,Math.random()*1.6+0.4,0,Math.PI*2); ctx.fill(); }
          ctx.beginPath(); ctx.moveTo(0, topY);
          for(let x=0;x<=w;x+=3){ const y=topY - 3*DPR + noise(x)*3*DPR; ctx.lineTo(x,y); } ctx.lineTo(w, topY); ctx.closePath(); ctx.fillStyle='rgba(255,255,255,0.06)'; ctx.fill();
        }

        if (compH>0){
          const area={x:0,y:h - sandH - compH,w:w,h:compH}; const waveY=area.y + 6*DPR + Math.sin(t*1.8)*2*DPR;
          const grdW=ctx.createLinearGradient(0,area.y,0,area.y+area.h); grdW.addColorStop(0,'rgba(100,180,255,0.55)'); grdW.addColorStop(1,'rgba(30,90,180,0.7)');
          ctx.fillStyle=grdW; ctx.fillRect(area.x,area.y,area.w,area.h);
          if(bubblesBottom.length<28) spawn(bubblesBottom, area, 2);
          for(let i=bubblesBottom.length-1;i>=0;i--){ const b=bubblesBottom[i]; b.y+=b.vy; b.x+=Math.sin((t+i)*0.8)*0.2*DPR+b.drift; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fillStyle='rgba(255,255,255,0.5)'; ctx.fill(); if(b.y<area.y+4*DPR) bubblesBottom.splice(i,1); }
          ctx.beginPath(); ctx.moveTo(0,waveY); for(let x=0;x<=w;x+=4){ const y=waveY + Math.sin(x*0.04 + t*2.2)*2*DPR + Math.sin(x*0.025 + t*1.7)*1.2*DPR; ctx.lineTo(x,y);} ctx.lineTo(w,area.y); ctx.lineTo(0,area.y); ctx.closePath(); ctx.fillStyle='rgba(255,255,255,0.08)'; ctx.fill();
        }

        if (overH>0){
          const area={x:0,y:half - overH,w:w,h:overH}; const waveY=area.y + 6*DPR + Math.sin(t*2.0)*2*DPR;
          const grdW2=ctx.createLinearGradient(0,area.y,0,area.y+area.h); grdW2.addColorStop(0,'rgba(120,200,255,0.55)'); grdW2.addColorStop(1,'rgba(10,70,160,0.75)');
          ctx.fillStyle=grdW2; ctx.fillRect(area.x,area.y,area.w,area.h);
          if(bubblesTop.length<20) spawn(bubblesTop, area, 1);
          for(let i=bubblesTop.length-1;i>=0;i--){ const b=bubblesTop[i]; b.y+=b.vy; b.x+=Math.sin((t+i)*1.1)*0.25*DPR+b.drift; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fillStyle='rgba(255,255,255,0.5)'; ctx.fill(); if(b.y<area.y+2*DPR) bubblesTop.splice(i,1); }
          ctx.beginPath(); ctx.moveTo(0,waveY); for(let x=0;x<=w;x+=4){ const y=waveY + Math.sin(x*0.05 + t*2.0)*2*DPR + Math.sin(x*0.03 + t*1.6)*1.2*DPR; ctx.lineTo(x,y);} ctx.lineTo(w,area.y); ctx.lineTo(0,area.y); ctx.closePath(); ctx.fillStyle='rgba(255,255,255,0.08)'; ctx.fill();
        }

        // midline
        ctx.strokeStyle='rgba(255,255,255,0.06)'; ctx.lineWidth=1*DPR; ctx.beginPath(); ctx.moveTo(0,h*0.5); ctx.lineTo(w,h*0.5); ctx.stroke();

        // Cracks (static, full coverage; also when overtime>0)
        const full = fullCrack || overtime>0;
        if(full){
          if(crackPaths.length===0) computeCracks();
          ctx.save();
          ctx.globalAlpha = 0.9;
          ctx.strokeStyle = 'rgba(255,255,255,0.9)';
          ctx.lineWidth = 1*DPR;
          crackPaths.forEach(pts=>{
            ctx.beginPath();
            ctx.moveTo(pts[0][0], pts[0][1]);
            for(let i=1;i<pts.length;i++){ ctx.lineTo(pts[i][0], pts[i][1]); }
            ctx.stroke();
          });
          ctx.restore();
        }

        raf = requestAnimationFrame(draw);
      }
      function start(){ cancel(); size(); computeCracks(); raf = requestAnimationFrame(draw); }
      function cancel(){ if(raf) cancelAnimationFrame(raf); raf=0; }
      const ro = new ResizeObserver(()=>start()); ro.observe(canvas);
      requestAnimationFrame(start);
      return { cancel, start };
    }

    const views={menu:document.getElementById('view-menu'),calendar:document.getElementById('view-calendar'),logger:document.getElementById('view-logger')};
    function show(n){for(const v in views) views[v].classList.remove('active'); views[n].classList.add('active'); backBtn.style.visibility = (n==='menu') ? 'hidden' : 'visible'; if(n==='menu') renderMenu(); if(n==='calendar') renderWeek(); if(n==='logger') renderLogger();}
    document.getElementById('goCalendar').addEventListener('click',()=>show('calendar'));
    document.getElementById('goLogger').addEventListener('click',()=>show('logger'));
    backBtn.addEventListener('click', ()=> show('menu'));

    function renderMenu(){ const ws=startOfWeekMon(new Date()); let sum=0; for(let i=0;i<7;i++){ sum+=workMins(toDateStr(addDays(ws,i))); } document.getElementById('pillWeek').textContent='Weekly hours: '+fmtHM(sum); document.getElementById('pillBank').textContent='Overtime bank: '+fmtSignedHM(overtimeBank()); }

    const weekTitle=document.getElementById('wTitle'), weekStrip=document.getElementById('weekStrip'), calFooter=document.getElementById('calFooter'); let weekStart=startOfWeekMon(new Date());
    const dayControllers = new Map();

    function renderWeek(){
      const ws=new Date(weekStart), we=addDays(ws,6);
      weekTitle.textContent = `${ws.getDate()} ${monthNames[ws.getMonth()]} – ${we.getDate()} ${monthNames[we.getMonth()]} ${we.getFullYear()}`;
      for (const ctrl of dayControllers.values()) ctrl.cancel?.();
      dayControllers.clear();
      weekStrip.innerHTML = '';
      let weekSum = 0;

      for (let i=0;i<7;i++){
        const d = addDays(ws,i);
        const ds = toDateStr(d);
        const worked = workMins(ds);
        const compUsed = compMins(ds);
        const overtime = Math.max(0, worked - TARGET);
        weekSum += worked;

        const wrap = document.createElement('div'); wrap.className='day-wrap';
        const el = document.createElement('div'); el.className='day'; if (ds===toDateStr(new Date())) el.classList.add('today');
        el.innerHTML = `<span class="n">${dows[(d.getDay()+6)%7]} ${d.getDate()}</span><span class="pct">${Math.round(Math.min(1,(worked+compUsed)/TARGET)*100)}%</span><span class="h">${worked?fmtHM(worked):''}</span>`;
        const canvas = document.createElement('canvas'); el.appendChild(canvas);
        requestAnimationFrame(()=>{
          const ctrl = SandWater(canvas, Math.min(worked, TARGET), compUsed, overtime, (worked - TARGET) > 0);
          dayControllers.set(el, ctrl);
        });
        el.addEventListener('click', ()=> openBubbleCentered(ds, worked, compUsed, overtime, (worked - TARGET) > 0));

        const fb = document.createElement('button'); fb.className='fill-btn'; fb.textContent = 'Fill missing time';
        if (compUsed>0 && (worked+compUsed)>=TARGET) fb.classList.add('active');
        fb.addEventListener('click', (ev)=>{
          ev.stopPropagation();
          const need = Math.max(0, TARGET - workMins(ds));
          const current = compMins(ds);
          const next = (current === need) ? 0 : need;
          if(next>0){ state.comp[ds] = { mins: next, note: 'auto-fill' }; } else { delete state.comp[ds]; }
          save(); renderMenu(); renderWeek();
        });

        wrap.appendChild(el); wrap.appendChild(fb);
        weekStrip.appendChild(wrap);
      }

      calFooter.innerHTML = `<strong>Weekly hours:</strong> ${fmtHM(weekSum)} · <strong>Overtime bank:</strong> ${fmtSignedHM(overtimeBank())}`;
    }

    function nowHHMM(){ const n=new Date(); return `${pad(n.getHours())}:${pad(n.getMinutes())}`; }
    function parseHHMM(t){ const [h,m]=t.split(':').map(Number); return h*60+m; }
    function validTime(t){ return /^\d{2}:\d{2}$/.test(t); }
    const breaksPane=document.getElementById('breaksPane');
    function computeTotal(){ const a=document.getElementById('startTime').value.trim(), b=document.getElementById('stopTime').value.trim(); if(!validTime(a)||!validTime(b)){ document.getElementById('computedTotal').textContent='0h 00m'; return 0; }
      let work=parseHHMM(b)-parseHHMM(a); if(work<0) work+=24*60; let bt=0; breaksPane.querySelectorAll('.break-item').forEach(it=>{ const s=it.querySelector('.bi-start').value.trim(), e=it.querySelector('.bi-stop').value.trim(); if(validTime(s)&&validTime(e)){ let m=parseHHMM(e)-parseHHMM(s); if(m>0) bt+=m; }});
      const net=Math.max(0,work-bt); document.getElementById('computedTotal').textContent=fmtHM(net); return net; }
    function addBreakRow(i={name:'',start:'',stop:''}){ const row=document.createElement('div'); row.className='break-item'; row.style.display='grid'; row.style.gridTemplateColumns='1.2fr 1fr 1fr auto'; row.style.gap='6px'; row.style.marginBottom='6px'; row.innerHTML=`
      <div><label>Name</label><input type="text" class="bi-name" value="${i.name||''}" placeholder="Lunch / Errand"></div>
      <div><label>Start</label><input type="time" class="bi-start" value="${i.start||''}"></div>
      <div><label>Stop</label><input type="time" class="bi-stop" value="${i.stop||''}"></div>
      <div style="align-self:end"><button class="btn bi-del">Remove</button></div>`; breaksPane.appendChild(row);
      row.querySelectorAll('input').forEach(inp=>inp.addEventListener('input',computeTotal)); row.querySelector('.bi-del').addEventListener('click',()=>{row.remove();computeTotal();}); computeTotal(); }
    function clearLoggerFor(ds){ document.getElementById('startTime').value=''; document.getElementById('stopTime').value=''; breaksPane.innerHTML=''; document.getElementById('computedTotal').textContent='0h 00m'; const w=state.work[ds]; document.getElementById('holidayFlag').checked=!!(w&&w.holiday);
      if(w){ document.getElementById('startTime').value=w.start||''; document.getElementById('stopTime').value=w.stop||''; (w.breaks||[]).forEach(b=>addBreakRow(b)); computeTotal(); } }
    function renderLogger(){ const input=document.getElementById('logDate'); if(!input.value) input.value=toDateStr(new Date()); clearLoggerFor(input.value); }
    document.getElementById('logDate').addEventListener('change',e=>clearLoggerFor(e.target.value));
    document.getElementById('btnStartNow').addEventListener('click',()=>{document.getElementById('startTime').value=nowHHMM(); computeTotal();});
    document.getElementById('btnStopNow').addEventListener('click',()=>{document.getElementById('stopTime').value=nowHHMM(); computeTotal();});
    document.getElementById('btnAddBreak').addEventListener('click',()=>addBreakRow());
    document.getElementById('startTime').addEventListener('input',computeTotal); document.getElementById('stopTime').addEventListener('input',computeTotal);
    document.getElementById('btnSave').addEventListener('click',()=>{ const ds=document.getElementById('logDate').value||toDateStr(new Date()); const a=document.getElementById('startTime').value.trim(), b=document.getElementById('stopTime').value.trim(); if(!/^\d{2}:\d{2}$/.test(a)||!/^\d{2}:\d{2}$/.test(b)){alert('Enter both start and stop times');return;}
      const net=computeTotal(); const breaks=[]; document.querySelectorAll('#breaksPane .break-item').forEach(it=>breaks.push({name:it.querySelector('.bi-name').value.trim(),start:it.querySelector('.bi-start').value.trim(),stop:it.querySelector('.bi-stop').value.trim()}));
      const holiday=document.getElementById('holidayFlag').checked; state.work[ds]={start:a,stop:b,breaks,netMins:net,holiday}; save(); renderMenu(); renderWeek(); show('menu'); });
    document.getElementById('btnResetWork').addEventListener('click',()=>{ const ds=document.getElementById('logDate').value||toDateStr(new Date()); if(state.work[ds]) delete state.work[ds]; if(state.comp[ds]) delete state.comp[ds]; save(); clearLoggerFor(ds); renderMenu(); renderWeek(); });

    // Bubble
    const focusLayer=document.getElementById('focusLayer'), bubble=document.getElementById('bubble'), bubbleCanvas=document.getElementById('bubbleCanvas'), bubbleOptions=document.getElementById('bubbleOptions'), bubbleDateLbl=document.getElementById('bubbleDate'), bubbleDetails=document.getElementById('bubbleDetails');
    let bubbleCtrl=null, bubbleDate=null;
    function openBubbleCentered(ds, worked, compUsed, overtime, fullCrack){
      bubbleDate = ds;
      bubbleDateLbl.textContent = ds;
      const vw = window.innerWidth, vh = window.innerHeight;
      const bw = Math.min(360, vw - 32), bh = 200;
      bubble.style.width = bw + 'px'; bubble.style.height = bh + 'px';
      bubble.style.left = (vw/2 - bw/2) + 'px'; bubble.style.top  = (vh/2 - bh/2) + 'px';
      bubbleOptions.style.top = (vh/2 + bh/2 + 10) + 'px'; bubbleOptions.style.left = '16px'; bubbleOptions.style.right = '16px';
      bubbleDetails.style.top = (vh/2 + bh/2 + 10 + 120) + 'px';

      const wObj = state.work[ds]||{};
      document.getElementById('dBreaks').textContent= (wObj.breaks||[]).map(b=>`${b.name||'Break'} ${b.start}-${b.stop}`).join(', ') || '—';
      document.getElementById('dWorked').textContent= fmtHM(worked);
      document.getElementById('dCompUsed').textContent= fmtHM(compUsed);
      document.getElementById('dOver').textContent  = fmtHM(Math.max(0,overtime));

      focusLayer.classList.add('active');
      if(navigator.vibrate){ navigator.vibrate(10); }

      if(bubbleCtrl) bubbleCtrl.cancel();
      requestAnimationFrame(()=>{
        bubbleCtrl = SandWater(bubbleCanvas, Math.min(worked,504), compUsed, Math.max(0,overtime), fullCrack);
      });
    }
    document.getElementById('focusBackdrop').addEventListener('click',()=>{ focusLayer.classList.remove('active'); if(bubbleCtrl) bubbleCtrl.cancel(); });
    document.getElementById('optEditLog').addEventListener('click',()=>{ if(bubbleDate){ document.getElementById('logDate').value=bubbleDate; renderLogger(); focusLayer.classList.remove('active'); if(bubbleCtrl) bubbleCtrl.cancel(); show('logger'); } });
    document.getElementById('optFillMissing').addEventListener('click',()=>{
      if(!bubbleDate) return;
      const ds=bubbleDate;
      const need = Math.max(0, 504 - workMins(ds));
      const current = compMins(ds);
      const next = (current === need) ? 0 : need;
      if(next>0){ state.comp[ds] = { mins: next, note: 'auto-fill' }; } else { delete state.comp[ds]; }
      save(); renderMenu(); renderWeek();
      const worked = workMins(ds), compUsed = compMins(ds), overtime = Math.max(0, worked-504), fullCrack=(worked-504)>0;
      if(bubbleCtrl) bubbleCtrl.cancel();
      requestAnimationFrame(()=>{
        bubbleCtrl = SandWater(bubbleCanvas, Math.min(worked,504), compUsed, Math.max(0,overtime), fullCrack);
      });
      document.getElementById('dCompUsed').textContent=fmtHM(compUsed);
    });
    document.getElementById('optResetDay').addEventListener('click',()=>{
      if(!bubbleDate) return;
      const ds=bubbleDate; if(state.work[ds]) delete state.work[ds]; if(state.comp[ds]) delete state.comp[ds]; save(); renderMenu(); renderWeek(); focusLayer.classList.remove('active'); if(bubbleCtrl) bubbleCtrl.cancel();
    });

    // Boot
    show('menu');
    if('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js');
  </script>
</body>
</html>
